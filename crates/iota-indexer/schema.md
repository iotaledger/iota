# Database Schema

---

The Indexer pulls checkpoint data from the full node and populates the tables shown in the ERD diagram:

![Database Schema](./database_schema.svg)

> **NOTE**
>
> Since all tables are populated from checkpoint data the entities are closely related, in the `SQL` files the foreign keys
> are not specified, a manual study of data is needed to understand all relations.
>
> Migrations are generated by diesel cli, the basic schema can be found [schema.rs](src/schema.rs). For a more in depth
> understanding of the
> database tables, go to [migrations](migrations) folder, in the contained `SQL` the indexes, partitions &
> constraints are declared.
>
> - Tables `objects_history` & `transactions` have partitions, each partition is created based
> on `checkpoint_sequence_number` (related form the `checkpoints` table) it goes from `0` to `MAXVALUE`
> - `__diesel_schema_migrations` table is managed by `diesel` cli when applying migrations

---
## Indexes
These are the following tables indexes: 

- ### Checkpoints
|          Keys          |
|:----------------------:|
| epoch, sequence_number |
|   checkpoint_digest    |

- ### Events

|                                  Keys                                   |
|:-----------------------------------------------------------------------:|
|           package, tx_sequence_number, event_sequence_number            |
|       package, module, tx_sequence_number, event_sequence_number        |
| event_type, text_pattern_ops, tx_sequence_number, event_sequence_number |
|                       checkpoint_sequence_number                        |

 - ### Objects

|            Keys            |                         Condition                         |
|:--------------------------:|:---------------------------------------------------------:|
|    owner_type, owner_id    | WHERE owner_type BETWEEN 1 AND 2 AND owner_id IS NOT NULL |
|    owner_id, coin_type     |      WHERE coin_type IS NOT NULL AND owner_type = 1       |
| checkpoint_sequence_number |                                                           |
|        object_type         |                                                           |

 - ### Objects Snapshot
|              Keys               |                         Condition                         |
|:-------------------------------:|:---------------------------------------------------------:|
|   checkpoint_sequence_number    |                                                           |
| owner_id, coin_type, object_id  |      WHERE coin_type IS NOT NULL AND owner_type = 1       |
|     object_type, object_id      |                                                           |
| owner_type, owner_id, object_id | WHERE owner_type BETWEEN 1 AND 2 AND owner_id IS NOT NULL |

- ### Objects History
|                       Keys                       |                         Condition                         |
|:------------------------------------------------:|:---------------------------------------------------------:|
| checkpoint_sequence_number, owner_type, owner_id | WHERE owner_type BETWEEN 1 AND 2 AND owner_id IS NOT NULL |
| checkpoint_sequence_number, owner_id, coin_type  |      WHERE coin_type IS NOT NULL AND owner_type = 1       |
|     checkpoint_sequence_number, object_type      |                                                           |

- ### Transactions
|            Keys            |         Condition          |
|:--------------------------:|:--------------------------:|
|     transaction_digest     |                            |
| checkpoint_sequence_number |                            |
|      transaction_kind      | WHERE transaction_kind = 1 |
                                   
- ### Tx Calls
|                   Keys                    |
|:-----------------------------------------:|
|    package, module, tx_sequence_number    |
| package, module, func, tx_sequence_number |
|            tx_sequence_number             |
                                   
- ### Tx Senders,  Tx Recipients
|        Keys        | Condition |
|:------------------:|:---------:|
| tx_sequence_number |    ASC    |

---
## Partitions
Some tables also provide dedicated partitions:

- ### Transactions, Objects History
|            Keys            |             Condition             |
|:--------------------------:|:---------------------------------:|
| checkpoint_sequence_number | FOR VALUES FROM (0) TO (MAXVALUE) |
