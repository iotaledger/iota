# Database Schema

The Indexer pulls checkpoint data from the full node and populates the tables shown in the ERD diagram:

![Database Schema](./database_schema.svg)

> **NOTE**
>
> Since all tables are populated from checkpoint data the entities are closely related, in the `SQL` files the foreign keys are not specified, a manual study of data is needed to understand all relations.
>
> Migrations are generated by diesel cli, the basic schema can be found [schema.rs](src/schema.rs).
> For more in depth understanding of the database tables, go to [migrations](migrations) folder, in the contained `SQL` the indexes, partitions & constraints are declared.
>
> - Tables `objects_history` & `transactions` have partitions, each partition is created based on `checkpoint_sequence_number` (related form the `checkpoints` table) it goes from `0` to `MAXVALUE`
> - `__diesel_schema_migrations` table is managed by `diesel` cli when applying migrations

## Indexes

### Table `checkpoints`

| Index name         | Keys                   |
| ------------------ | ---------------------- |
| checkpoints_epoch  | epoch, sequence_number |
| checkpoints_digest | checkpoint_digest      |

### Table `events`

| Index name                        | Keys                                                                    |
| --------------------------------- | ----------------------------------------------------------------------- |
| events_package                    | package, tx_sequence_number, event_sequence_number                      |
| events_package_module             | package, module, tx_sequence_number, event_sequence_number              |
| events_event_type                 | event_type, text_pattern_ops, tx_sequence_number, event_sequence_number |
| events_checkpoint_sequence_number | checkpoint_sequence_number                                              |

### Table `objects`

| Index name                         | Keys                       | Condition                                                 |
| ---------------------------------- | -------------------------- | --------------------------------------------------------- |
| objects_owner                      | owner_type, owner_id       | WHERE owner_type BETWEEN 1 AND 2 AND owner_id IS NOT NULL |
| objects_coin                       | owner_id, coin_type        | WHERE coin_type IS NOT NULL AND owner_type = 1            |
| objects_checkpoint_sequence_number | checkpoint_sequence_number |                                                           |
| objects_type                       | object_type                |                                                           |

### Table `objects_snapshot`

| Index name                                  | Keys                            | Condition                                                 |
| ------------------------------------------- | ------------------------------- | --------------------------------------------------------- |
| objects_snapshot_checkpoint_sequence_number | checkpoint_sequence_number      |                                                           |
| objects_snapshot_coin                       | owner_id, coin_type, object_id  | WHERE coin_type IS NOT NULL AND owner_type = 1            |
| objects_snapshot_type                       | object_type, object_id          |                                                           |
| objects_snapshot_owner                      | owner_type, owner_id, object_id | WHERE owner_type BETWEEN 1 AND 2 AND owner_id IS NOT NULL |

### Table `objects_history`

| Index name            | Keys                                             | Condition                                                 |
| --------------------- | ------------------------------------------------ | --------------------------------------------------------- |
| objects_history_owner | checkpoint_sequence_number, owner_type, owner_id | WHERE owner_type BETWEEN 1 AND 2 AND owner_id IS NOT NULL |
| objects_history_coin  | checkpoint_sequence_number, owner_id, coin_type  | WHERE coin_type IS NOT NULL AND owner_type = 1            |
| objects_history_type  | checkpoint_sequence_number, object_type          |                                                           |

### Table `transactions`

| Index name                              | Keys                       | Condition                  |
| --------------------------------------- | -------------------------- | -------------------------- |
| transactions_transaction_digest         | transaction_digest         |                            |
| transactions_checkpoint_sequence_number | checkpoint_sequence_number |                            |
| transactions_transaction_kind           | transaction_kind           | WHERE transaction_kind = 1 |

### Table `tx_calls`

| Index name                  | Keys                                      |
| --------------------------- | ----------------------------------------- |
| tx_calls_module             | package, module, tx_sequence_number       |
| tx_calls_func               | package, module, func, tx_sequence_number |
| tx_calls_tx_sequence_number | tx_sequence_number                        |

### Table `tx_senders`

| Index name                          | Keys               | Condition |
| ----------------------------------- | ------------------ | --------- |
| tx_senders_tx_sequence_number_index | tx_sequence_number | ASC       |

### Tables `tx_recipients`

| Index name                             | Keys               | Condition |
| -------------------------------------- | ------------------ | --------- |
| tx_recipients_tx_sequence_number_index | tx_sequence_number | ASC       |

### Table `tx_count_metrics`

| Index name                    | Keys         |
| ----------------------------- | ------------ |
| tx_count_metrics_epoch        | epoch        |
| tx_count_metrics_timestamp_ms | timestamp_ms |

### Table `move_calls`

| Index name               | Keys                                            |
| ------------------------ | ----------------------------------------------- |
| idx_move_calls_epoch_etc | epoch, move_package, move_module, move_function |

### Table `move_call_metrics`

| Index name                  | Keys       |
| --------------------------- | ---------- |
| move_call_metrics_epoch_day | epoch, day |

### Table `address_metrics`

| Index name                | Keys  |
| ------------------------- | ----- |
| address_metrics_epoch_idx | epoch |

## Partitions

### Tables `transactions`, `objects_history`

| Keys                       | Condition                         |
| -------------------------- | --------------------------------- |
| checkpoint_sequence_number | FOR VALUES FROM (0) TO (MAXVALUE) |
