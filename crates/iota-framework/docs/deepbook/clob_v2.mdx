---
title: Module `0xdee9::clob_v2`
---
import Link from '@docusaurus/Link';

<Link id="0xdee9_clob_v2"/>


-  [Struct `PoolCreated`](#0xdee9_clob_v2_PoolCreated)
-  [Struct `OrderPlaced`](#0xdee9_clob_v2_OrderPlaced)
-  [Struct `OrderCanceled`](#0xdee9_clob_v2_OrderCanceled)
-  [Struct `AllOrdersCanceledComponent`](#0xdee9_clob_v2_AllOrdersCanceledComponent)
-  [Struct `AllOrdersCanceled`](#0xdee9_clob_v2_AllOrdersCanceled)
-  [Struct `OrderFilled`](#0xdee9_clob_v2_OrderFilled)
-  [Struct `DepositAsset`](#0xdee9_clob_v2_DepositAsset)
-  [Struct `WithdrawAsset`](#0xdee9_clob_v2_WithdrawAsset)
-  [Struct `MatchedOrderMetadata`](#0xdee9_clob_v2_MatchedOrderMetadata)
-  [Struct `Order`](#0xdee9_clob_v2_Order)
-  [Struct `TickLevel`](#0xdee9_clob_v2_TickLevel)
-  [Resource `Pool`](#0xdee9_clob_v2_Pool)
-  [Resource `PoolOwnerCap`](#0xdee9_clob_v2_PoolOwnerCap)
-  [Constants](#@Constants_0)
-  [Function `usr_open_orders_exist`](#0xdee9_clob_v2_usr_open_orders_exist)
-  [Function `usr_open_orders_for_address`](#0xdee9_clob_v2_usr_open_orders_for_address)
-  [Function `usr_open_orders`](#0xdee9_clob_v2_usr_open_orders)
-  [Function `withdraw_fees`](#0xdee9_clob_v2_withdraw_fees)
-  [Function `delete_pool_owner_cap`](#0xdee9_clob_v2_delete_pool_owner_cap)
-  [Function `destroy_empty_level`](#0xdee9_clob_v2_destroy_empty_level)
-  [Function `create_account`](#0xdee9_clob_v2_create_account)
-  [Function `create_pool_`](#0xdee9_clob_v2_create_pool_)
-  [Function `create_pool`](#0xdee9_clob_v2_create_pool)
-  [Function `create_customized_pool`](#0xdee9_clob_v2_create_customized_pool)
-  [Function `create_pool_with_return_`](#0xdee9_clob_v2_create_pool_with_return_)
-  [Function `create_pool_with_return`](#0xdee9_clob_v2_create_pool_with_return)
-  [Function `create_customized_pool_with_return`](#0xdee9_clob_v2_create_customized_pool_with_return)
-  [Function `create_customized_pool_v2`](#0xdee9_clob_v2_create_customized_pool_v2)
-  [Function `deposit_base`](#0xdee9_clob_v2_deposit_base)
-  [Function `deposit_quote`](#0xdee9_clob_v2_deposit_quote)
-  [Function `withdraw_base`](#0xdee9_clob_v2_withdraw_base)
-  [Function `withdraw_quote`](#0xdee9_clob_v2_withdraw_quote)
-  [Function `swap_exact_base_for_quote`](#0xdee9_clob_v2_swap_exact_base_for_quote)
-  [Function `swap_exact_base_for_quote_with_metadata`](#0xdee9_clob_v2_swap_exact_base_for_quote_with_metadata)
-  [Function `swap_exact_quote_for_base`](#0xdee9_clob_v2_swap_exact_quote_for_base)
-  [Function `swap_exact_quote_for_base_with_metadata`](#0xdee9_clob_v2_swap_exact_quote_for_base_with_metadata)
-  [Function `match_bid_with_quote_quantity`](#0xdee9_clob_v2_match_bid_with_quote_quantity)
-  [Function `match_bid`](#0xdee9_clob_v2_match_bid)
-  [Function `match_ask`](#0xdee9_clob_v2_match_ask)
-  [Function `place_market_order`](#0xdee9_clob_v2_place_market_order)
-  [Function `place_market_order_with_metadata`](#0xdee9_clob_v2_place_market_order_with_metadata)
-  [Function `place_market_order_int`](#0xdee9_clob_v2_place_market_order_int)
-  [Function `inject_limit_order`](#0xdee9_clob_v2_inject_limit_order)
-  [Function `place_limit_order`](#0xdee9_clob_v2_place_limit_order)
-  [Function `place_limit_order_with_metadata`](#0xdee9_clob_v2_place_limit_order_with_metadata)
-  [Function `place_limit_order_int`](#0xdee9_clob_v2_place_limit_order_int)
-  [Function `order_is_bid`](#0xdee9_clob_v2_order_is_bid)
-  [Function `emit_order_canceled`](#0xdee9_clob_v2_emit_order_canceled)
-  [Function `emit_order_filled`](#0xdee9_clob_v2_emit_order_filled)
-  [Function `cancel_order`](#0xdee9_clob_v2_cancel_order)
-  [Function `remove_order`](#0xdee9_clob_v2_remove_order)
-  [Function `cancel_all_orders`](#0xdee9_clob_v2_cancel_all_orders)
-  [Function `batch_cancel_order`](#0xdee9_clob_v2_batch_cancel_order)
-  [Function `clean_up_expired_orders`](#0xdee9_clob_v2_clean_up_expired_orders)
-  [Function `list_open_orders`](#0xdee9_clob_v2_list_open_orders)
-  [Function `account_balance`](#0xdee9_clob_v2_account_balance)
-  [Function `get_market_price`](#0xdee9_clob_v2_get_market_price)
-  [Function `get_level2_book_status_bid_side`](#0xdee9_clob_v2_get_level2_book_status_bid_side)
-  [Function `get_level2_book_status_ask_side`](#0xdee9_clob_v2_get_level2_book_status_ask_side)
-  [Function `get_level2_book_status`](#0xdee9_clob_v2_get_level2_book_status)
-  [Function `get_order_status`](#0xdee9_clob_v2_get_order_status)
-  [Function `matched_order_metadata`](#0xdee9_clob_v2_matched_order_metadata)
-  [Function `matched_order_metadata_info`](#0xdee9_clob_v2_matched_order_metadata_info)
-  [Function `asks`](#0xdee9_clob_v2_asks)
-  [Function `bids`](#0xdee9_clob_v2_bids)
-  [Function `tick_size`](#0xdee9_clob_v2_tick_size)
-  [Function `maker_rebate_rate`](#0xdee9_clob_v2_maker_rebate_rate)
-  [Function `taker_fee_rate`](#0xdee9_clob_v2_taker_fee_rate)
-  [Function `pool_size`](#0xdee9_clob_v2_pool_size)
-  [Function `open_orders`](#0xdee9_clob_v2_open_orders)
-  [Function `order_id`](#0xdee9_clob_v2_order_id)
-  [Function `tick_level`](#0xdee9_clob_v2_tick_level)
-  [Function `original_quantity`](#0xdee9_clob_v2_original_quantity)
-  [Function `quantity`](#0xdee9_clob_v2_quantity)
-  [Function `is_bid`](#0xdee9_clob_v2_is_bid)
-  [Function `owner`](#0xdee9_clob_v2_owner)
-  [Function `expire_timestamp`](#0xdee9_clob_v2_expire_timestamp)
-  [Function `quote_asset_trading_fees_value`](#0xdee9_clob_v2_quote_asset_trading_fees_value)
-  [Function `clone_order`](#0xdee9_clob_v2_clone_order)


<pre><code>
<b>use</b> <Link to="../move-stdlib/option#0x1_option">0x1::option</Link>;
<b>use</b> <Link to="../move-stdlib/type_name#0x1_type_name">0x1::type_name</Link>;
<b>use</b> <Link to="../move-stdlib/vector#0x1_vector">0x1::vector</Link>;
<b>use</b> <Link to="../iota-framework/balance#0x2_balance">0x2::balance</Link>;
<b>use</b> <Link to="../iota-framework/clock#0x2_clock">0x2::clock</Link>;
<b>use</b> <Link to="../iota-framework/coin#0x2_coin">0x2::coin</Link>;
<b>use</b> <Link to="../iota-framework/event#0x2_event">0x2::event</Link>;
<b>use</b> <Link to="../iota-framework/iota#0x2_iota">0x2::iota</Link>;
<b>use</b> <Link to="../iota-framework/linked_table#0x2_linked_table">0x2::linked_table</Link>;
<b>use</b> <Link to="../iota-framework/object#0x2_object">0x2::object</Link>;
<b>use</b> <Link to="../iota-framework/table#0x2_table">0x2::table</Link>;
<b>use</b> <Link to="../iota-framework/transfer#0x2_transfer">0x2::transfer</Link>;
<b>use</b> <Link to="../iota-framework/tx_context#0x2_tx_context">0x2::tx_context</Link>;
<b>use</b> <Link to="critbit#0xdee9_critbit">0xdee9::critbit</Link>;
<b>use</b> <Link to="custodian_v2#0xdee9_custodian_v2">0xdee9::custodian_v2</Link>;
<b>use</b> <Link to="math#0xdee9_math">0xdee9::math</Link>;
</code></pre>



<Link id="0xdee9_clob_v2_PoolCreated"></Link>

## Struct `PoolCreated`

Emitted when a new pool is created


<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_PoolCreated">PoolCreated</Link> <b>has</b> <b>copy</b>, drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link></code>
</dt>
<dd>
 object ID of the newly created pool
</dd>
<dt>
<code>
base_asset: <Link to="../move-stdlib/type_name#0x1_type_name_TypeName">type_name::TypeName</Link></code>
</dt>
<dd>

</dd>
<dt>
<code>
quote_asset: <Link to="../move-stdlib/type_name#0x1_type_name_TypeName">type_name::TypeName</Link></code>
</dt>
<dd>

</dd>
<dt>
<code>
taker_fee_rate: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
maker_rebate_rate: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
tick_size: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
lot_size: u64</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_OrderPlaced"></Link>

## Struct `OrderPlaced`

Emitted when a maker order is injected into the order book.


<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_OrderPlaced">OrderPlaced</Link>&lt;BaseAsset, QuoteAsset&gt; <b>has</b> <b>copy</b>, drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link></code>
</dt>
<dd>
 object ID of the pool the order was placed on
</dd>
<dt>
<code>
order_id: u64</code>
</dt>
<dd>
 ID of the order within the pool
</dd>
<dt>
<code>
client_order_id: u64</code>
</dt>
<dd>
 ID of the order defined by client
</dd>
<dt>
<code>
is_bid: bool</code>
</dt>
<dd>

</dd>
<dt>
<code>
owner: <b>address</b></code>
</dt>
<dd>
 owner ID of the <code>
AccountCap</code> that placed the order
</dd>
<dt>
<code>
original_quantity: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
base_asset_quantity_placed: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
price: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
expire_timestamp: u64</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_OrderCanceled"></Link>

## Struct `OrderCanceled`

Emitted when a maker order is canceled.


<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_OrderCanceled">OrderCanceled</Link>&lt;BaseAsset, QuoteAsset&gt; <b>has</b> <b>copy</b>, drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link></code>
</dt>
<dd>
 object ID of the pool the order was placed on
</dd>
<dt>
<code>
order_id: u64</code>
</dt>
<dd>
 ID of the order within the pool
</dd>
<dt>
<code>
client_order_id: u64</code>
</dt>
<dd>
 ID of the order defined by client
</dd>
<dt>
<code>
is_bid: bool</code>
</dt>
<dd>

</dd>
<dt>
<code>
owner: <b>address</b></code>
</dt>
<dd>
 owner ID of the <code>
AccountCap</code> that canceled the order
</dd>
<dt>
<code>
original_quantity: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
base_asset_quantity_canceled: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
price: u64</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_AllOrdersCanceledComponent"></Link>

## Struct `AllOrdersCanceledComponent`

A struct to make all orders canceled a more effifient struct


<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceledComponent">AllOrdersCanceledComponent</Link>&lt;BaseAsset, QuoteAsset&gt; <b>has</b> <b>copy</b>, drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
order_id: u64</code>
</dt>
<dd>
 ID of the order within the pool
</dd>
<dt>
<code>
client_order_id: u64</code>
</dt>
<dd>
 ID of the order defined by client
</dd>
<dt>
<code>
is_bid: bool</code>
</dt>
<dd>

</dd>
<dt>
<code>
owner: <b>address</b></code>
</dt>
<dd>
 owner ID of the <code>
AccountCap</code> that canceled the order
</dd>
<dt>
<code>
original_quantity: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
base_asset_quantity_canceled: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
price: u64</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_AllOrdersCanceled"></Link>

## Struct `AllOrdersCanceled`

Emitted when batch of orders are canceled.


<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceled">AllOrdersCanceled</Link>&lt;BaseAsset, QuoteAsset&gt; <b>has</b> <b>copy</b>, drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link></code>
</dt>
<dd>
 object ID of the pool the order was placed on
</dd>
<dt>
<code>
orders_canceled: <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceledComponent">clob_v2::AllOrdersCanceledComponent</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_OrderFilled"></Link>

## Struct `OrderFilled`

Emitted only when a maker order is filled.


<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_OrderFilled">OrderFilled</Link>&lt;BaseAsset, QuoteAsset&gt; <b>has</b> <b>copy</b>, drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link></code>
</dt>
<dd>
 object ID of the pool the order was placed on
</dd>
<dt>
<code>
order_id: u64</code>
</dt>
<dd>
 ID of the order within the pool
</dd>
<dt>
<code>
taker_client_order_id: u64</code>
</dt>
<dd>
 ID of the order defined by taker client
</dd>
<dt>
<code>
maker_client_order_id: u64</code>
</dt>
<dd>
 ID of the order defined by maker client
</dd>
<dt>
<code>
is_bid: bool</code>
</dt>
<dd>

</dd>
<dt>
<code>
taker_address: <b>address</b></code>
</dt>
<dd>
 owner ID of the <code>
AccountCap</code> that filled the order
</dd>
<dt>
<code>
maker_address: <b>address</b></code>
</dt>
<dd>
 owner ID of the <code>
AccountCap</code> that placed the order
</dd>
<dt>
<code>
original_quantity: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
base_asset_quantity_filled: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
base_asset_quantity_remaining: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
price: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
taker_commission: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
maker_rebates: u64</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_DepositAsset"></Link>

## Struct `DepositAsset`

Emitted when user deposit asset to custodian


<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_DepositAsset">DepositAsset</Link>&lt;Asset&gt; <b>has</b> <b>copy</b>, drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link></code>
</dt>
<dd>
 object id of the pool that asset deposit to
</dd>
<dt>
<code>
quantity: u64</code>
</dt>
<dd>
 quantity of the asset deposited
</dd>
<dt>
<code>
owner: <b>address</b></code>
</dt>
<dd>
 owner address of the <code>
AccountCap</code> that deposit the asset
</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_WithdrawAsset"></Link>

## Struct `WithdrawAsset`

Emitted when user withdraw asset from custodian


<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_WithdrawAsset">WithdrawAsset</Link>&lt;Asset&gt; <b>has</b> <b>copy</b>, drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link></code>
</dt>
<dd>
 object id of the pool that asset withdraw from
</dd>
<dt>
<code>
quantity: u64</code>
</dt>
<dd>
 quantity of the asset user withdrew
</dd>
<dt>
<code>
owner: <b>address</b></code>
</dt>
<dd>
 owner ID of the <code>
AccountCap</code> that withdrew the asset
</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_MatchedOrderMetadata"></Link>

## Struct `MatchedOrderMetadata`

Returned as metadata only when a maker order is filled from place order functions.


<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt; <b>has</b> <b>copy</b>, drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link></code>
</dt>
<dd>
 object ID of the pool the order was placed on
</dd>
<dt>
<code>
order_id: u64</code>
</dt>
<dd>
 ID of the order within the pool
</dd>
<dt>
<code>
is_bid: bool</code>
</dt>
<dd>
 Direction of order.
</dd>
<dt>
<code>
taker_address: <b>address</b></code>
</dt>
<dd>
 owner ID of the <code>
AccountCap</code> that filled the order
</dd>
<dt>
<code>
maker_address: <b>address</b></code>
</dt>
<dd>
 owner ID of the <code>
AccountCap</code> that placed the order
</dd>
<dt>
<code>
base_asset_quantity_filled: u64</code>
</dt>
<dd>
 qty of base asset filled.
</dd>
<dt>
<code>
price: u64</code>
</dt>
<dd>
 price at which basset asset filled.
</dd>
<dt>
<code>
taker_commission: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
maker_rebates: u64</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_Order"></Link>

## Struct `Order`



<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link> <b>has</b> drop, store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
order_id: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
client_order_id: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
price: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
original_quantity: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
quantity: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
is_bid: bool</code>
</dt>
<dd>

</dd>
<dt>
<code>
owner: <b>address</b></code>
</dt>
<dd>
 Order can only be canceled by the <code>
AccountCap</code> with this owner ID
</dd>
<dt>
<code>
expire_timestamp: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
self_matching_prevention: u8</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_TickLevel"></Link>

## Struct `TickLevel`



<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link> <b>has</b> store
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
price: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
open_orders: <Link to="../iota-framework/linked_table#0x2_linked_table_LinkedTable">linked_table::LinkedTable</Link>&lt;u64, <Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>&gt;</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_Pool"></Link>

## Resource `Pool`



<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt; <b>has</b> store, key
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
id: <Link to="../iota-framework/object#0x2_object_UID">object::UID</Link></code>
</dt>
<dd>

</dd>
<dt>
<code>
bids: <Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">clob_v2::TickLevel</Link>&gt;</code>
</dt>
<dd>

</dd>
<dt>
<code>
asks: <Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">clob_v2::TickLevel</Link>&gt;</code>
</dt>
<dd>

</dd>
<dt>
<code>
next_bid_order_id: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
next_ask_order_id: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
usr_open_orders: <Link to="../iota-framework/table#0x2_table_Table">table::Table</Link>&lt;<b>address</b>, <Link to="../iota-framework/linked_table#0x2_linked_table_LinkedTable">linked_table::LinkedTable</Link>&lt;u64, u64&gt;&gt;</code>
</dt>
<dd>

</dd>
<dt>
<code>
taker_fee_rate: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
maker_rebate_rate: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
tick_size: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
lot_size: u64</code>
</dt>
<dd>

</dd>
<dt>
<code>
base_custodian: <Link to="custodian_v2#0xdee9_custodian_v2_Custodian">custodian_v2::Custodian</Link>&lt;BaseAsset&gt;</code>
</dt>
<dd>

</dd>
<dt>
<code>
quote_custodian: <Link to="custodian_v2#0xdee9_custodian_v2_Custodian">custodian_v2::Custodian</Link>&lt;QuoteAsset&gt;</code>
</dt>
<dd>

</dd>
<dt>
<code>
creation_fee: <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;<Link to="../iota-framework/iota#0x2_iota_IOTA">iota::IOTA</Link>&gt;</code>
</dt>
<dd>

</dd>
<dt>
<code>
base_asset_trading_fees: <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;BaseAsset&gt;</code>
</dt>
<dd>

</dd>
<dt>
<code>
quote_asset_trading_fees: <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;QuoteAsset&gt;</code>
</dt>
<dd>

</dd>
</dl>


</details>

<Link id="0xdee9_clob_v2_PoolOwnerCap"></Link>

## Resource `PoolOwnerCap`

Capability granting permission to access an entry in <code>
<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>.quote_asset_trading_fees</code>.
The pool objects created for older pools do not have a PoolOwnerCap because they were created
prior to the addition of this feature. Here is a list of 11 pools on mainnet that
do not have this capability:
0x31d1790e617eef7f516555124155b28d663e5c600317c769a75ee6336a54c07f
0x6e417ee1c12ad5f2600a66bc80c7bd52ff3cb7c072d508700d17cf1325324527
0x17625f1a241d34d2da0dc113086f67a2b832e3e8cd8006887c195cd24d3598a3
0x276ff4d99ecb3175091ba4baffa9b07590f84e2344e3f16e95d30d2c1678b84c
0xd1f0a9baacc1864ab19534e2d4c5d6c14f2e071a1f075e8e7f9d51f2c17dc238
0x4405b50d791fd3346754e8171aaab6bc2ed26c2c46efdd033c14b30ae507ac33
0xf0f663cf87f1eb124da2fc9be813e0ce262146f3df60bc2052d738eb41a25899
0xd9e45ab5440d61cc52e3b2bd915cdd643146f7593d587c715bc7bfa48311d826
0x5deafda22b6b86127ea4299503362638bea0ca33bb212ea3a67b029356b8b955
0x7f526b1263c4b91b43c9e646419b5696f424de28dda3c1e6658cc0a54558baa7
0x18d871e3c3da99046dfc0d3de612c5d88859bc03b8f0568bd127d0e70dbc58be


<pre><code>
<b>struct</b> <Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">PoolOwnerCap</Link> <b>has</b> store, key
</code></pre>



<details>
<summary>Fields</summary>


<dl>
<dt>
<code>
id: <Link to="../iota-framework/object#0x2_object_UID">object::UID</Link></code>
</dt>
<dd>

</dd>
<dt>
<code>
owner: <b>address</b></code>
</dt>
<dd>
 The owner of this AccountCap. Note: this is
 derived from an object ID, not a user address
</dd>
</dl>


</details>

<Link id="@Constants_0"></Link>

## Constants


<Link id="0xdee9_clob_v2_FLOAT_SCALING"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_FLOAT_SCALING">FLOAT_SCALING</Link>: u64 = 1000000000;
</code></pre>



<Link id="0xdee9_clob_v2_EInsufficientBaseCoin"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInsufficientBaseCoin">EInsufficientBaseCoin</Link>: u64 = 7;
</code></pre>



<Link id="0xdee9_clob_v2_EInsufficientQuoteCoin"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInsufficientQuoteCoin">EInsufficientQuoteCoin</Link>: u64 = 8;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidExpireTimestamp"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidExpireTimestamp">EInvalidExpireTimestamp</Link>: u64 = 19;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidOrderId"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidOrderId">EInvalidOrderId</Link>: u64 = 3;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidPrice"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidPrice">EInvalidPrice</Link>: u64 = 5;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidQuantity"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidQuantity">EInvalidQuantity</Link>: u64 = 6;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidRestriction"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidRestriction">EInvalidRestriction</Link>: u64 = 14;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidTickPrice"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidTickPrice">EInvalidTickPrice</Link>: u64 = 11;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidUser"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidUser">EInvalidUser</Link>: u64 = 12;
</code></pre>



<Link id="0xdee9_clob_v2_EOrderCannotBeFullyFilled"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EOrderCannotBeFullyFilled">EOrderCannotBeFullyFilled</Link>: u64 = 9;
</code></pre>



<Link id="0xdee9_clob_v2_EOrderCannotBeFullyPassive"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EOrderCannotBeFullyPassive">EOrderCannotBeFullyPassive</Link>: u64 = 10;
</code></pre>



<Link id="0xdee9_clob_v2_EUnauthorizedCancel"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EUnauthorizedCancel">EUnauthorizedCancel</Link>: u64 = 4;
</code></pre>



<Link id="0xdee9_clob_v2_FILL_OR_KILL"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_FILL_OR_KILL">FILL_OR_KILL</Link>: u8 = 2;
</code></pre>



<Link id="0xdee9_clob_v2_IMMEDIATE_OR_CANCEL"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_IMMEDIATE_OR_CANCEL">IMMEDIATE_OR_CANCEL</Link>: u8 = 1;
</code></pre>



<Link id="0xdee9_clob_v2_MAX_PRICE"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_MAX_PRICE">MAX_PRICE</Link>: u64 = 9223372036854775808;
</code></pre>



<Link id="0xdee9_clob_v2_MIN_ASK_ORDER_ID"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_MIN_ASK_ORDER_ID">MIN_ASK_ORDER_ID</Link>: u64 = 9223372036854775808;
</code></pre>



<Link id="0xdee9_clob_v2_MIN_PRICE"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_MIN_PRICE">MIN_PRICE</Link>: u64 = 0;
</code></pre>



<Link id="0xdee9_clob_v2_NO_RESTRICTION"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_NO_RESTRICTION">NO_RESTRICTION</Link>: u8 = 0;
</code></pre>



<Link id="0xdee9_clob_v2_POST_OR_ABORT"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_POST_OR_ABORT">POST_OR_ABORT</Link>: u8 = 3;
</code></pre>



<Link id="0xdee9_clob_v2_CANCEL_OLDEST"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_CANCEL_OLDEST">CANCEL_OLDEST</Link>: u8 = 0;
</code></pre>



<Link id="0xdee9_clob_v2_EIncorrectPoolOwner"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EIncorrectPoolOwner">EIncorrectPoolOwner</Link>: u64 = 1;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidFee"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidFee">EInvalidFee</Link>: u64 = 18;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidFeeRateRebateRate"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidFeeRateRebateRate">EInvalidFeeRateRebateRate</Link>: u64 = 2;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidPair"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidPair">EInvalidPair</Link>: u64 = 16;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidSelfMatchingPreventionArg"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidSelfMatchingPreventionArg">EInvalidSelfMatchingPreventionArg</Link>: u64 = 21;
</code></pre>



<Link id="0xdee9_clob_v2_EInvalidTickSizeLotSize"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_EInvalidTickSizeLotSize">EInvalidTickSizeLotSize</Link>: u64 = 20;
</code></pre>



<Link id="0xdee9_clob_v2_ENotEqual"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_ENotEqual">ENotEqual</Link>: u64 = 13;
</code></pre>



<Link id="0xdee9_clob_v2_FEE_AMOUNT_FOR_CREATE_POOL"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_FEE_AMOUNT_FOR_CREATE_POOL">FEE_AMOUNT_FOR_CREATE_POOL</Link>: u64 = 100000000000;
</code></pre>



<Link id="0xdee9_clob_v2_MIN_BID_ORDER_ID"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_MIN_BID_ORDER_ID">MIN_BID_ORDER_ID</Link>: u64 = 1;
</code></pre>



<Link id="0xdee9_clob_v2_REFERENCE_MAKER_REBATE_RATE"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_REFERENCE_MAKER_REBATE_RATE">REFERENCE_MAKER_REBATE_RATE</Link>: u64 = 1500000;
</code></pre>



<Link id="0xdee9_clob_v2_REFERENCE_TAKER_FEE_RATE"></Link>



<pre><code>
<b>const</b> <Link to="clob_v2#0xdee9_clob_v2_REFERENCE_TAKER_FEE_RATE">REFERENCE_TAKER_FEE_RATE</Link>: u64 = 2500000;
</code></pre>



<Link id="0xdee9_clob_v2_usr_open_orders_exist"></Link>

## Function `usr_open_orders_exist`

Accessor functions


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_usr_open_orders_exist">usr_open_orders_exist</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, owner: <b>address</b>): bool
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_usr_open_orders_exist">usr_open_orders_exist</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    owner: <b>address</b>
): bool \{
    <Link to="../iota-framework/table#0x2_table_contains">table::contains</Link>(&pool.usr_open_orders, owner)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_usr_open_orders_for_address"></Link>

## Function `usr_open_orders_for_address`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_usr_open_orders_for_address">usr_open_orders_for_address</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, owner: <b>address</b>): &<Link to="../iota-framework/linked_table#0x2_linked_table_LinkedTable">linked_table::LinkedTable</Link>&lt;u64, u64&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_usr_open_orders_for_address">usr_open_orders_for_address</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    owner: <b>address</b>
): &LinkedTable&lt;u64, u64&gt; \{
    <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&pool.usr_open_orders, owner)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_usr_open_orders"></Link>

## Function `usr_open_orders`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_usr_open_orders">usr_open_orders</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): &<Link to="../iota-framework/table#0x2_table_Table">table::Table</Link>&lt;<b>address</b>, <Link to="../iota-framework/linked_table#0x2_linked_table_LinkedTable">linked_table::LinkedTable</Link>&lt;u64, u64&gt;&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_usr_open_orders">usr_open_orders</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
): &Table&lt;<b>address</b>, LinkedTable&lt;u64, u64&gt;&gt; \{
    &pool.usr_open_orders
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_withdraw_fees"></Link>

## Function `withdraw_fees`

Function to withdraw fees created from a pool


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_withdraw_fees">withdraw_fees</Link>&lt;BaseAsset, QuoteAsset&gt;(pool_owner_cap: &<Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">clob_v2::PoolOwnerCap</Link>, pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_withdraw_fees">withdraw_fees</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool_owner_cap: &<Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">PoolOwnerCap</Link>,
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    ctx: &<b>mut</b> TxContext,
): Coin&lt;QuoteAsset&gt; \{
    <b>assert</b>!(pool_owner_cap.owner == <Link to="../iota-framework/object#0x2_object_uid_to_address">object::uid_to_address</Link>(&pool.id), <Link to="clob_v2#0xdee9_clob_v2_EIncorrectPoolOwner">EIncorrectPoolOwner</Link>);
    <b>let</b> quantity = <Link to="clob_v2#0xdee9_clob_v2_quote_asset_trading_fees_value">quote_asset_trading_fees_value</Link>(pool);
    <b>let</b> to_withdraw = <Link to="../iota-framework/balance#0x2_balance_split">balance::split</Link>(&<b>mut</b> pool.quote_asset_trading_fees, quantity);
    <Link to="../iota-framework/coin#0x2_coin_from_balance">coin::from_balance</Link>(to_withdraw, ctx)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_delete_pool_owner_cap"></Link>

## Function `delete_pool_owner_cap`

Destroy the given <code>
pool_owner_cap</code> object


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_delete_pool_owner_cap">delete_pool_owner_cap</Link>(pool_owner_cap: <Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">clob_v2::PoolOwnerCap</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_delete_pool_owner_cap">delete_pool_owner_cap</Link>(pool_owner_cap: <Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">PoolOwnerCap</Link>) \{
    <b>let</b> <Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">PoolOwnerCap</Link> \{ id, owner: _ } = pool_owner_cap;
    <Link to="../iota-framework/object#0x2_object_delete">object::delete</Link>(id)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_destroy_empty_level"></Link>

## Function `destroy_empty_level`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_destroy_empty_level">destroy_empty_level</Link>(level: <Link to="clob_v2#0xdee9_clob_v2_TickLevel">clob_v2::TickLevel</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_destroy_empty_level">destroy_empty_level</Link>(level: <Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link>) \{
    <b>let</b> <Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link> \{
        price: _,
        open_orders: orders,
    } = level;

    <Link to="../iota-framework/linked_table#0x2_linked_table_destroy_empty">linked_table::destroy_empty</Link>(orders);
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_create_account"></Link>

## Function `create_account`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_account">create_account</Link>(ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): <Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_account">create_account</Link>(ctx: &<b>mut</b> TxContext): AccountCap \{
    mint_account_cap(ctx)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_create_pool_"></Link>

## Function `create_pool_`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_pool_">create_pool_</Link>&lt;BaseAsset, QuoteAsset&gt;(taker_fee_rate: u64, maker_rebate_rate: u64, tick_size: u64, lot_size: u64, creation_fee: <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;<Link to="../iota-framework/iota#0x2_iota_IOTA">iota::IOTA</Link>&gt;, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_pool_">create_pool_</Link>&lt;BaseAsset, QuoteAsset&gt;(
    taker_fee_rate: u64,
    maker_rebate_rate: u64,
    tick_size: u64,
    lot_size: u64,
    creation_fee: Balance&lt;IOTA&gt;,
    ctx: &<b>mut</b> TxContext,
) \{
    <b>let</b> (pool, pool_owner_cap) = <Link to="clob_v2#0xdee9_clob_v2_create_pool_with_return_">create_pool_with_return_</Link>&lt;BaseAsset, QuoteAsset&gt;(
        taker_fee_rate,
        maker_rebate_rate,
        tick_size,
        lot_size,
        creation_fee,
        ctx
    );

    <Link to="../iota-framework/transfer#0x2_transfer_public_transfer">transfer::public_transfer</Link>(pool_owner_cap, <Link to="../iota-framework/tx_context#0x2_tx_context_sender">tx_context::sender</Link>(ctx));
    <Link to="../iota-framework/transfer#0x2_transfer_share_object">transfer::share_object</Link>(pool);
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_create_pool"></Link>

## Function `create_pool`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_pool">create_pool</Link>&lt;BaseAsset, QuoteAsset&gt;(tick_size: u64, lot_size: u64, creation_fee: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;<Link to="../iota-framework/iota#0x2_iota_IOTA">iota::IOTA</Link>&gt;, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_pool">create_pool</Link>&lt;BaseAsset, QuoteAsset&gt;(
    tick_size: u64,
    lot_size: u64,
    creation_fee: Coin&lt;IOTA&gt;,
    ctx: &<b>mut</b> TxContext,
) \{
    <Link to="clob_v2#0xdee9_clob_v2_create_customized_pool">create_customized_pool</Link>&lt;BaseAsset, QuoteAsset&gt;(
        tick_size,
        lot_size,
        <Link to="clob_v2#0xdee9_clob_v2_REFERENCE_TAKER_FEE_RATE">REFERENCE_TAKER_FEE_RATE</Link>,
        <Link to="clob_v2#0xdee9_clob_v2_REFERENCE_MAKER_REBATE_RATE">REFERENCE_MAKER_REBATE_RATE</Link>,
        creation_fee,
        ctx,
    );
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_create_customized_pool"></Link>

## Function `create_customized_pool`

Function for creating pool with customized taker fee rate and maker rebate rate.
The taker_fee_rate should be greater than or equal to the maker_rebate_rate, and both should have a scaling of 10^9.
Taker_fee_rate of 0.25% should be 2_500_000 for example


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_customized_pool">create_customized_pool</Link>&lt;BaseAsset, QuoteAsset&gt;(tick_size: u64, lot_size: u64, taker_fee_rate: u64, maker_rebate_rate: u64, creation_fee: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;<Link to="../iota-framework/iota#0x2_iota_IOTA">iota::IOTA</Link>&gt;, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_customized_pool">create_customized_pool</Link>&lt;BaseAsset, QuoteAsset&gt;(
    tick_size: u64,
    lot_size: u64,
    taker_fee_rate: u64,
    maker_rebate_rate: u64,
    creation_fee: Coin&lt;IOTA&gt;,
    ctx: &<b>mut</b> TxContext,
) \{
    <Link to="clob_v2#0xdee9_clob_v2_create_pool_">create_pool_</Link>&lt;BaseAsset, QuoteAsset&gt;(
        taker_fee_rate,
        maker_rebate_rate,
        tick_size,
        lot_size,
        <Link to="../iota-framework/coin#0x2_coin_into_balance">coin::into_balance</Link>(creation_fee),
        ctx
    )
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_create_pool_with_return_"></Link>

## Function `create_pool_with_return_`

Helper function that all the create pools now call to create pools.


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_pool_with_return_">create_pool_with_return_</Link>&lt;BaseAsset, QuoteAsset&gt;(taker_fee_rate: u64, maker_rebate_rate: u64, tick_size: u64, lot_size: u64, creation_fee: <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;<Link to="../iota-framework/iota#0x2_iota_IOTA">iota::IOTA</Link>&gt;, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, <Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">clob_v2::PoolOwnerCap</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_pool_with_return_">create_pool_with_return_</Link>&lt;BaseAsset, QuoteAsset&gt;(
    taker_fee_rate: u64,
    maker_rebate_rate: u64,
    tick_size: u64,
    lot_size: u64,
    creation_fee: Balance&lt;IOTA&gt;,
    ctx: &<b>mut</b> TxContext,
): (<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, <Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">PoolOwnerCap</Link>) \{
    <b>assert</b>!(<Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&creation_fee) == <Link to="clob_v2#0xdee9_clob_v2_FEE_AMOUNT_FOR_CREATE_POOL">FEE_AMOUNT_FOR_CREATE_POOL</Link>, <Link to="clob_v2#0xdee9_clob_v2_EInvalidFee">EInvalidFee</Link>);

    <b>let</b> base_type_name = <Link to="../move-stdlib/type_name#0x1_type_name_get">type_name::get</Link>&lt;BaseAsset&gt;();
    <b>let</b> quote_type_name = <Link to="../move-stdlib/type_name#0x1_type_name_get">type_name::get</Link>&lt;QuoteAsset&gt;();

    <b>assert</b>!(clob_math::unsafe_mul(lot_size, tick_size) &gt; 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidTickSizeLotSize">EInvalidTickSizeLotSize</Link>);
    <b>assert</b>!(base_type_name != quote_type_name, <Link to="clob_v2#0xdee9_clob_v2_EInvalidPair">EInvalidPair</Link>);
    <b>assert</b>!(taker_fee_rate &gt;= maker_rebate_rate, <Link to="clob_v2#0xdee9_clob_v2_EInvalidFeeRateRebateRate">EInvalidFeeRateRebateRate</Link>);

    <b>let</b> pool_uid = <Link to="../iota-framework/object#0x2_object_new">object::new</Link>(ctx);
    <b>let</b> pool_id = *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool_uid);

    // Creates the capability <b>to</b> mark a pool owner.
    <b>let</b> id = <Link to="../iota-framework/object#0x2_object_new">object::new</Link>(ctx);
    <b>let</b> owner = <Link to="../iota-framework/object#0x2_object_uid_to_address">object::uid_to_address</Link>(&pool_uid);
    <b>let</b> pool_owner_cap = <Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">PoolOwnerCap</Link> \{ id, owner };

    <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_PoolCreated">PoolCreated</Link> \{
        pool_id,
        base_asset: base_type_name,
        quote_asset: quote_type_name,
        taker_fee_rate,
        maker_rebate_rate,
        tick_size,
        lot_size,
    });
    (<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt; \{
        id: pool_uid,
        bids: <Link to="critbit#0xdee9_critbit_new">critbit::new</Link>(ctx),
        asks: <Link to="critbit#0xdee9_critbit_new">critbit::new</Link>(ctx),
        next_bid_order_id: <Link to="clob_v2#0xdee9_clob_v2_MIN_BID_ORDER_ID">MIN_BID_ORDER_ID</Link>,
        next_ask_order_id: <Link to="clob_v2#0xdee9_clob_v2_MIN_ASK_ORDER_ID">MIN_ASK_ORDER_ID</Link>,
        usr_open_orders: <Link to="../iota-framework/table#0x2_table_new">table::new</Link>(ctx),
        taker_fee_rate,
        maker_rebate_rate,
        tick_size,
        lot_size,
        base_custodian: <Link to="custodian#0xdee9_custodian_new">custodian::new</Link>&lt;BaseAsset&gt;(ctx),
        quote_custodian: <Link to="custodian#0xdee9_custodian_new">custodian::new</Link>&lt;QuoteAsset&gt;(ctx),
        creation_fee,
        base_asset_trading_fees: <Link to="../iota-framework/balance#0x2_balance_zero">balance::zero</Link>(),
        quote_asset_trading_fees: <Link to="../iota-framework/balance#0x2_balance_zero">balance::zero</Link>(),
    }, pool_owner_cap)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_create_pool_with_return"></Link>

## Function `create_pool_with_return`

Function for creating an external pool. This API can be used to wrap deepbook pools into other objects.


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_pool_with_return">create_pool_with_return</Link>&lt;BaseAsset, QuoteAsset&gt;(tick_size: u64, lot_size: u64, creation_fee: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;<Link to="../iota-framework/iota#0x2_iota_IOTA">iota::IOTA</Link>&gt;, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_pool_with_return">create_pool_with_return</Link>&lt;BaseAsset, QuoteAsset&gt;(
    tick_size: u64,
    lot_size: u64,
    creation_fee: Coin&lt;IOTA&gt;,
    ctx: &<b>mut</b> TxContext,
): <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt; \{
    <Link to="clob_v2#0xdee9_clob_v2_create_customized_pool_with_return">create_customized_pool_with_return</Link>&lt;BaseAsset, QuoteAsset&gt;(
        tick_size,
        lot_size,
        <Link to="clob_v2#0xdee9_clob_v2_REFERENCE_TAKER_FEE_RATE">REFERENCE_TAKER_FEE_RATE</Link>,
        <Link to="clob_v2#0xdee9_clob_v2_REFERENCE_MAKER_REBATE_RATE">REFERENCE_MAKER_REBATE_RATE</Link>,
        creation_fee,
        ctx,
    )
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_create_customized_pool_with_return"></Link>

## Function `create_customized_pool_with_return`

Function for creating pool with customized taker fee rate and maker rebate rate.
The taker_fee_rate should be greater than or equal to the maker_rebate_rate, and both should have a scaling of 10^9.
Taker_fee_rate of 0.25% should be 2_500_000 for example


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_customized_pool_with_return">create_customized_pool_with_return</Link>&lt;BaseAsset, QuoteAsset&gt;(tick_size: u64, lot_size: u64, taker_fee_rate: u64, maker_rebate_rate: u64, creation_fee: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;<Link to="../iota-framework/iota#0x2_iota_IOTA">iota::IOTA</Link>&gt;, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_customized_pool_with_return">create_customized_pool_with_return</Link>&lt;BaseAsset, QuoteAsset&gt;(
    tick_size: u64,
    lot_size: u64,
    taker_fee_rate: u64,
    maker_rebate_rate: u64,
    creation_fee: Coin&lt;IOTA&gt;,
    ctx: &<b>mut</b> TxContext,
) : <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt; \{
    <b>let</b> (pool, pool_owner_cap) = <Link to="clob_v2#0xdee9_clob_v2_create_pool_with_return_">create_pool_with_return_</Link>&lt;BaseAsset, QuoteAsset&gt;(
        taker_fee_rate,
        maker_rebate_rate,
        tick_size,
        lot_size,
        <Link to="../iota-framework/coin#0x2_coin_into_balance">coin::into_balance</Link>(creation_fee),
        ctx
    );
    <Link to="../iota-framework/transfer#0x2_transfer_public_transfer">transfer::public_transfer</Link>(pool_owner_cap, <Link to="../iota-framework/tx_context#0x2_tx_context_sender">tx_context::sender</Link>(ctx));
    pool
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_create_customized_pool_v2"></Link>

## Function `create_customized_pool_v2`

A V2 function for creating customized pools for better PTB friendliness/compostability.
If a user wants to create a pool and then destroy/lock the pool_owner_cap one can do
so with this function.


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_customized_pool_v2">create_customized_pool_v2</Link>&lt;BaseAsset, QuoteAsset&gt;(tick_size: u64, lot_size: u64, taker_fee_rate: u64, maker_rebate_rate: u64, creation_fee: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;<Link to="../iota-framework/iota#0x2_iota_IOTA">iota::IOTA</Link>&gt;, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, <Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">clob_v2::PoolOwnerCap</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_create_customized_pool_v2">create_customized_pool_v2</Link>&lt;BaseAsset, QuoteAsset&gt;(
    tick_size: u64,
    lot_size: u64,
    taker_fee_rate: u64,
    maker_rebate_rate: u64,
    creation_fee: Coin&lt;IOTA&gt;,
    ctx: &<b>mut</b> TxContext,
) : (<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, <Link to="clob_v2#0xdee9_clob_v2_PoolOwnerCap">PoolOwnerCap</Link>) \{
    <Link to="clob_v2#0xdee9_clob_v2_create_pool_with_return_">create_pool_with_return_</Link>&lt;BaseAsset, QuoteAsset&gt;(
        taker_fee_rate,
        maker_rebate_rate,
        tick_size,
        lot_size,
        <Link to="../iota-framework/coin#0x2_coin_into_balance">coin::into_balance</Link>(creation_fee),
        ctx
    )
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_deposit_base"></Link>

## Function `deposit_base`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_deposit_base">deposit_base</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, <Link to="../iota-framework/coin#0x2_coin">coin</Link>: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_deposit_base">deposit_base</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    <Link to="../iota-framework/coin#0x2_coin">coin</Link>: Coin&lt;BaseAsset&gt;,
    account_cap: &AccountCap
) \{
    <b>let</b> quantity = <Link to="../iota-framework/coin#0x2_coin_value">coin::value</Link>(&<Link to="../iota-framework/coin#0x2_coin">coin</Link>);
    <b>assert</b>!(quantity != 0, <Link to="clob_v2#0xdee9_clob_v2_EInsufficientBaseCoin">EInsufficientBaseCoin</Link>);
    <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>(
        &<b>mut</b> pool.base_custodian,
        account_owner(account_cap),
        <Link to="../iota-framework/coin#0x2_coin_into_balance">coin::into_balance</Link>(<Link to="../iota-framework/coin#0x2_coin">coin</Link>)
    );
    <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_DepositAsset">DepositAsset</Link>&lt;BaseAsset&gt;\{
        pool_id: *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
        quantity,
        owner: account_owner(account_cap)
    })
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_deposit_quote"></Link>

## Function `deposit_quote`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_deposit_quote">deposit_quote</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, <Link to="../iota-framework/coin#0x2_coin">coin</Link>: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_deposit_quote">deposit_quote</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    <Link to="../iota-framework/coin#0x2_coin">coin</Link>: Coin&lt;QuoteAsset&gt;,
    account_cap: &AccountCap
) \{
    <b>let</b> quantity = <Link to="../iota-framework/coin#0x2_coin_value">coin::value</Link>(&<Link to="../iota-framework/coin#0x2_coin">coin</Link>);
    <b>assert</b>!(quantity != 0, <Link to="clob_v2#0xdee9_clob_v2_EInsufficientQuoteCoin">EInsufficientQuoteCoin</Link>);
    <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>(
        &<b>mut</b> pool.quote_custodian,
        account_owner(account_cap),
        <Link to="../iota-framework/coin#0x2_coin_into_balance">coin::into_balance</Link>(<Link to="../iota-framework/coin#0x2_coin">coin</Link>)
    );
    <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_DepositAsset">DepositAsset</Link>&lt;QuoteAsset&gt;\{
        pool_id: *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
        quantity,
        owner: account_owner(account_cap)
    })
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_withdraw_base"></Link>

## Function `withdraw_base`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_withdraw_base">withdraw_base</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, quantity: u64, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_withdraw_base">withdraw_base</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    quantity: u64,
    account_cap: &AccountCap,
    ctx: &<b>mut</b> TxContext
): Coin&lt;BaseAsset&gt; \{
    <b>assert</b>!(quantity &gt; 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidQuantity">EInvalidQuantity</Link>);
    <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_WithdrawAsset">WithdrawAsset</Link>&lt;BaseAsset&gt;\{
        pool_id: *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
        quantity,
        owner: account_owner(account_cap)
    });
    <Link to="custodian#0xdee9_custodian_withdraw_asset">custodian::withdraw_asset</Link>(&<b>mut</b> pool.base_custodian, quantity, account_cap, ctx)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_withdraw_quote"></Link>

## Function `withdraw_quote`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_withdraw_quote">withdraw_quote</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, quantity: u64, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_withdraw_quote">withdraw_quote</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    quantity: u64,
    account_cap: &AccountCap,
    ctx: &<b>mut</b> TxContext
): Coin&lt;QuoteAsset&gt; \{
    <b>assert</b>!(quantity &gt; 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidQuantity">EInvalidQuantity</Link>);
    <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_WithdrawAsset">WithdrawAsset</Link>&lt;QuoteAsset&gt;\{
        pool_id: *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
        quantity,
        owner: account_owner(account_cap)
    });
    <Link to="custodian#0xdee9_custodian_withdraw_asset">custodian::withdraw_asset</Link>(&<b>mut</b> pool.quote_custodian, quantity, account_cap, ctx)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_swap_exact_base_for_quote"></Link>

## Function `swap_exact_base_for_quote`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_swap_exact_base_for_quote">swap_exact_base_for_quote</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, client_order_id: u64, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, quantity: u64, base_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, quote_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (<Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_swap_exact_base_for_quote">swap_exact_base_for_quote</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    client_order_id: u64,
    account_cap: &AccountCap,
    quantity: u64,
    base_coin: Coin&lt;BaseAsset&gt;,
    quote_coin: Coin&lt;QuoteAsset&gt;,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    ctx: &<b>mut</b> TxContext,
): (Coin&lt;BaseAsset&gt;, Coin&lt;QuoteAsset&gt;, u64) \{
    <b>assert</b>!(quantity &gt; 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidQuantity">EInvalidQuantity</Link>);
    <b>assert</b>!(<Link to="../iota-framework/coin#0x2_coin_value">coin::value</Link>(&base_coin) &gt;= quantity, <Link to="clob_v2#0xdee9_clob_v2_EInsufficientBaseCoin">EInsufficientBaseCoin</Link>);
    <b>let</b> original_val = <Link to="../iota-framework/coin#0x2_coin_value">coin::value</Link>(&quote_coin);
    <b>let</b> (ret_base_coin, ret_quote_coin) = <Link to="clob_v2#0xdee9_clob_v2_place_market_order">place_market_order</Link>(
        pool,
        account_cap,
        client_order_id,
        quantity,
        <b>false</b>,
        base_coin,
        quote_coin,
        <Link to="../iota-framework/clock#0x2_clock">clock</Link>,
        ctx
    );
    <b>let</b> ret_val = <Link to="../iota-framework/coin#0x2_coin_value">coin::value</Link>(&ret_quote_coin);
    (ret_base_coin, ret_quote_coin, ret_val - original_val)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_swap_exact_base_for_quote_with_metadata"></Link>

## Function `swap_exact_base_for_quote_with_metadata`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_swap_exact_base_for_quote_with_metadata">swap_exact_base_for_quote_with_metadata</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, client_order_id: u64, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, quantity: u64, base_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, quote_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (<Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, u64, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_swap_exact_base_for_quote_with_metadata">swap_exact_base_for_quote_with_metadata</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    client_order_id: u64,
    account_cap: &AccountCap,
    quantity: u64,
    base_coin: Coin&lt;BaseAsset&gt;,
    quote_coin: Coin&lt;QuoteAsset&gt;,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    ctx: &<b>mut</b> TxContext,
): (Coin&lt;BaseAsset&gt;, Coin&lt;QuoteAsset&gt;, u64, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;) \{
    <b>let</b> original_val = <Link to="../iota-framework/coin#0x2_coin_value">coin::value</Link>(&quote_coin);
    <b>let</b> (ret_base_coin, ret_quote_coin, <b>mut</b> matched_order_metadata) = <Link to="clob_v2#0xdee9_clob_v2_place_market_order_int">place_market_order_int</Link>(
        pool,
        account_cap,
        client_order_id,
        quantity,
        <b>false</b>,
        base_coin,
        quote_coin,
        <Link to="../iota-framework/clock#0x2_clock">clock</Link>,
        <b>true</b>, // <b>return</b> metadata
        ctx
    );
    <b>let</b> ret_val = <Link to="../iota-framework/coin#0x2_coin_value">coin::value</Link>(&ret_quote_coin);
    (ret_base_coin, ret_quote_coin, ret_val - original_val, <Link to="../move-stdlib/option#0x1_option_extract">option::extract</Link>(&<b>mut</b> matched_order_metadata))
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_swap_exact_quote_for_base"></Link>

## Function `swap_exact_quote_for_base`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_swap_exact_quote_for_base">swap_exact_quote_for_base</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, client_order_id: u64, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, quantity: u64, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, quote_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (<Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_swap_exact_quote_for_base">swap_exact_quote_for_base</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    client_order_id: u64,
    account_cap: &AccountCap,
    quantity: u64,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    quote_coin: Coin&lt;QuoteAsset&gt;,
    ctx: &<b>mut</b> TxContext,
): (Coin&lt;BaseAsset&gt;, Coin&lt;QuoteAsset&gt;, u64) \{
    <b>assert</b>!(quantity &gt; 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidQuantity">EInvalidQuantity</Link>);
    <b>assert</b>!(<Link to="../iota-framework/coin#0x2_coin_value">coin::value</Link>(&quote_coin) &gt;= quantity, <Link to="clob_v2#0xdee9_clob_v2_EInsufficientQuoteCoin">EInsufficientQuoteCoin</Link>);
    <b>let</b> (base_asset_balance, quote_asset_balance, _matched_order_metadata) = <Link to="clob_v2#0xdee9_clob_v2_match_bid_with_quote_quantity">match_bid_with_quote_quantity</Link>(
        pool,
        account_cap,
        client_order_id,
        quantity,
        <Link to="clob_v2#0xdee9_clob_v2_MAX_PRICE">MAX_PRICE</Link>,
        <Link to="../iota-framework/clock#0x2_clock_timestamp_ms">clock::timestamp_ms</Link>(<Link to="../iota-framework/clock#0x2_clock">clock</Link>),
        <Link to="../iota-framework/coin#0x2_coin_into_balance">coin::into_balance</Link>(quote_coin),
        <b>false</b> // don't <b>return</b> metadata
    );
    <b>let</b> val = <Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&base_asset_balance);
    (<Link to="../iota-framework/coin#0x2_coin_from_balance">coin::from_balance</Link>(base_asset_balance, ctx), <Link to="../iota-framework/coin#0x2_coin_from_balance">coin::from_balance</Link>(quote_asset_balance, ctx), val)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_swap_exact_quote_for_base_with_metadata"></Link>

## Function `swap_exact_quote_for_base_with_metadata`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_swap_exact_quote_for_base_with_metadata">swap_exact_quote_for_base_with_metadata</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, client_order_id: u64, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, quantity: u64, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, quote_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (<Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, u64, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_swap_exact_quote_for_base_with_metadata">swap_exact_quote_for_base_with_metadata</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    client_order_id: u64,
    account_cap: &AccountCap,
    quantity: u64,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    quote_coin: Coin&lt;QuoteAsset&gt;,
    ctx: &<b>mut</b> TxContext,
): (Coin&lt;BaseAsset&gt;, Coin&lt;QuoteAsset&gt;, u64, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;) \{
    <b>assert</b>!(quantity &gt; 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidQuantity">EInvalidQuantity</Link>);
    <b>assert</b>!(<Link to="../iota-framework/coin#0x2_coin_value">coin::value</Link>(&quote_coin) &gt;= quantity, <Link to="clob_v2#0xdee9_clob_v2_EInsufficientQuoteCoin">EInsufficientQuoteCoin</Link>);
    <b>let</b> (base_asset_balance, quote_asset_balance, <b>mut</b> matched_order_metadata) = <Link to="clob_v2#0xdee9_clob_v2_match_bid_with_quote_quantity">match_bid_with_quote_quantity</Link>(
        pool,
        account_cap,
        client_order_id,
        quantity,
        <Link to="clob_v2#0xdee9_clob_v2_MAX_PRICE">MAX_PRICE</Link>,
        <Link to="../iota-framework/clock#0x2_clock_timestamp_ms">clock::timestamp_ms</Link>(<Link to="../iota-framework/clock#0x2_clock">clock</Link>),
        <Link to="../iota-framework/coin#0x2_coin_into_balance">coin::into_balance</Link>(quote_coin),
        <b>true</b> // <b>return</b> metadata
    );
    <b>let</b> val = <Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&base_asset_balance);
    (<Link to="../iota-framework/coin#0x2_coin_from_balance">coin::from_balance</Link>(base_asset_balance, ctx), <Link to="../iota-framework/coin#0x2_coin_from_balance">coin::from_balance</Link>(quote_asset_balance, ctx), val, <Link to="../move-stdlib/option#0x1_option_extract">option::extract</Link>(&<b>mut</b> matched_order_metadata))
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_match_bid_with_quote_quantity"></Link>

## Function `match_bid_with_quote_quantity`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_match_bid_with_quote_quantity">match_bid_with_quote_quantity</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, client_order_id: u64, quantity: u64, price_limit: u64, current_timestamp: u64, quote_balance: <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;QuoteAsset&gt;, compute_metadata: bool): (<Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;BaseAsset&gt;, <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;QuoteAsset&gt;, <Link to="../move-stdlib/option#0x1_option_Option">option::Option</Link>&lt;<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_match_bid_with_quote_quantity">match_bid_with_quote_quantity</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    account_cap: &AccountCap,
    client_order_id: u64,
    quantity: u64,
    price_limit: u64,
    current_timestamp: u64,
    quote_balance: Balance&lt;QuoteAsset&gt;,
    compute_metadata: bool,
): (Balance&lt;BaseAsset&gt;, Balance&lt;QuoteAsset&gt;, Option&lt;<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;&gt;) \{
    // Base <Link to="../iota-framework/balance#0x2_balance">balance</Link> received by taker, taking into account of taker commission.
    // Need <b>to</b> individually keep track of the remaining base quantity <b>to</b> be filled <b>to</b> avoid infinite <b>loop</b>.
    <b>let</b> pool_id = *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id);
    <b>let</b> <b>mut</b> taker_quote_quantity_remaining = quantity;
    <b>let</b> <b>mut</b> base_balance_filled = <Link to="../iota-framework/balance#0x2_balance_zero">balance::zero</Link>&lt;BaseAsset&gt;();
    <b>let</b> <b>mut</b> quote_balance_left = quote_balance;
    <b>let</b> all_open_orders = &<b>mut</b> pool.asks;
    <b>let</b> <b>mut</b> matched_order_metadata = <Link to="../move-stdlib/vector#0x1_vector_empty">vector::empty</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;();
    <b>if</b> (<Link to="critbit#0xdee9_critbit_is_empty">critbit::is_empty</Link>(all_open_orders)) \{
        <b>return</b> (base_balance_filled, quote_balance_left, <Link to="../move-stdlib/option#0x1_option_none">option::none</Link>())
    };
    <b>let</b> (<b>mut</b> tick_price, <b>mut</b> tick_index) = min_leaf(all_open_orders);
    <b>let</b> <b>mut</b> terminate_loop = <b>false</b>;
    <b>let</b> <b>mut</b> canceled_order_events = <Link to="../move-stdlib/vector#0x1_vector">vector</Link>[];

    <b>while</b> (!is_empty&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link>&gt;(all_open_orders) && tick_price &lt;= price_limit) \{
        <b>let</b> tick_level = borrow_mut_leaf_by_index(all_open_orders, tick_index);
        <b>let</b> <b>mut</b> order_id = *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(<Link to="../iota-framework/linked_table#0x2_linked_table_front">linked_table::front</Link>(&tick_level.open_orders));

        <b>while</b> (!<Link to="../iota-framework/linked_table#0x2_linked_table_is_empty">linked_table::is_empty</Link>(&tick_level.open_orders)) \{
            <b>let</b> maker_order = <Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(&tick_level.open_orders, order_id);
            <b>let</b> <b>mut</b> maker_base_quantity = maker_order.quantity;
            <b>let</b> <b>mut</b> skip_order = <b>false</b>;

            <b>if</b> (maker_order.<Link to="clob_v2#0xdee9_clob_v2_expire_timestamp">expire_timestamp</Link> &lt;= current_timestamp || account_owner(account_cap) == maker_order.owner) \{
                skip_order = <b>true</b>;
                <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.base_custodian, maker_order.owner, maker_order.quantity);
                <b>let</b> canceled_order_event = <Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceledComponent">AllOrdersCanceledComponent</Link>&lt;BaseAsset, QuoteAsset&gt; \{
                    client_order_id: maker_order.client_order_id,
                    order_id: maker_order.order_id,
                    is_bid: maker_order.is_bid,
                    owner: maker_order.owner,
                    original_quantity: maker_order.original_quantity,
                    base_asset_quantity_canceled: maker_order.quantity,
                    price: maker_order.price
                };

                <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> canceled_order_events, canceled_order_event);

            } <b>else</b> \{
                // Calculate how much quote asset (maker_quote_quantity) is required, including the commission, <b>to</b> fill the maker order.
                <b>let</b> maker_quote_quantity_without_commission = clob_math::mul(
                    maker_base_quantity,
                    maker_order.price
                );
                <b>let</b> (is_round_down, <b>mut</b> taker_commission)  = clob_math::unsafe_mul_round(
                    maker_quote_quantity_without_commission,
                    pool.taker_fee_rate
                );
                <b>if</b> (is_round_down)  taker_commission = taker_commission + 1;

                <b>let</b> maker_quote_quantity = maker_quote_quantity_without_commission + taker_commission;

                // Total base quantity filled.
                <b>let</b> <b>mut</b> filled_base_quantity: u64;
                // Total quote quantity filled, excluding commission and rebate.
                <b>let</b> <b>mut</b> filled_quote_quantity: u64;
                // Total quote quantity paid by taker.
                // filled_quote_quantity_without_commission * (<Link to="clob_v2#0xdee9_clob_v2_FLOAT_SCALING">FLOAT_SCALING</Link> + taker_fee_rate) = filled_quote_quantity
                <b>let</b> <b>mut</b> filled_quote_quantity_without_commission: u64;
                <b>if</b> (taker_quote_quantity_remaining &gt; maker_quote_quantity) \{
                    filled_quote_quantity = maker_quote_quantity;
                    filled_quote_quantity_without_commission = maker_quote_quantity_without_commission;
                    filled_base_quantity = maker_base_quantity;
                } <b>else</b> \{
                    terminate_loop = <b>true</b>;
                    // <b>if</b> not enough quote quantity <b>to</b> pay for taker commission, then no quantity will be filled
                    filled_quote_quantity_without_commission = clob_math::unsafe_div(
                        taker_quote_quantity_remaining,
                        <Link to="clob_v2#0xdee9_clob_v2_FLOAT_SCALING">FLOAT_SCALING</Link> + pool.taker_fee_rate
                    );
                    // filled_base_quantity = 0 is permitted since filled_quote_quantity_without_commission can be 0
                    filled_base_quantity = clob_math::unsafe_div(
                        filled_quote_quantity_without_commission,
                        maker_order.price
                    );
                    <b>let</b> filled_base_lot = filled_base_quantity / pool.lot_size;
                    filled_base_quantity = filled_base_lot * pool.lot_size;
                    // filled_quote_quantity_without_commission = 0 is permitted here since filled_base_quantity could be 0
                    filled_quote_quantity_without_commission = clob_math::unsafe_mul(
                        filled_base_quantity,
                        maker_order.price
                    );
                    // <b>if</b> taker_commission = 0 due <b>to</b> underflow, round it up <b>to</b> 1
                    <b>let</b> (round_down, <b>mut</b> taker_commission) = clob_math::unsafe_mul_round(
                        filled_quote_quantity_without_commission,
                        pool.taker_fee_rate
                    );
                    <b>if</b> (round_down) \{
                        taker_commission = taker_commission + 1;
                    };
                    filled_quote_quantity = filled_quote_quantity_without_commission + taker_commission;
                };
                // <b>if</b> maker_rebate = 0 due <b>to</b> underflow, maker will not receive a rebate
                <b>let</b> maker_rebate = clob_math::unsafe_mul(
                    filled_quote_quantity_without_commission,
                    pool.maker_rebate_rate
                );
                maker_base_quantity = maker_base_quantity - filled_base_quantity;

                // maker in ask side, decrease maker's locked base asset, increase maker's available quote asset
                taker_quote_quantity_remaining = taker_quote_quantity_remaining - filled_quote_quantity;
                <b>let</b> locked_base_balance = <Link to="custodian#0xdee9_custodian_decrease_user_locked_balance">custodian::decrease_user_locked_balance</Link>&lt;BaseAsset&gt;(
                    &<b>mut</b> pool.base_custodian,
                    maker_order.owner,
                    filled_base_quantity
                );

                <b>let</b> <b>mut</b> quote_balance_filled = <Link to="../iota-framework/balance#0x2_balance_split">balance::split</Link>(
                    &<b>mut</b> quote_balance_left,
                    filled_quote_quantity,
                );
                // Send quote asset including rebate <b>to</b> maker.
                <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>&lt;QuoteAsset&gt;(
                    &<b>mut</b> pool.quote_custodian,
                    maker_order.owner,
                    <Link to="../iota-framework/balance#0x2_balance_split">balance::split</Link>(
                        &<b>mut</b> quote_balance_filled,
                        maker_rebate + filled_quote_quantity_without_commission,
                    ),
                );
                // Send remaining of commission - rebate <b>to</b> the protocol.
                // commission - rebate = filled_quote_quantity_without_commission - filled_quote_quantity - maker_rebate
                <Link to="../iota-framework/balance#0x2_balance_join">balance::join</Link>(&<b>mut</b> pool.quote_asset_trading_fees, quote_balance_filled);
                <Link to="../iota-framework/balance#0x2_balance_join">balance::join</Link>(&<b>mut</b> base_balance_filled, locked_base_balance);

                <Link to="clob_v2#0xdee9_clob_v2_emit_order_filled">emit_order_filled</Link>&lt;BaseAsset, QuoteAsset&gt;(
                    *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
                    client_order_id,
                    account_owner(account_cap),
                    maker_order,
                    filled_base_quantity,
                    // taker_commission = filled_quote_quantity - filled_quote_quantity_without_commission
                    // This guarantees that the subtraction will not underflow
                    filled_quote_quantity - filled_quote_quantity_without_commission,
                    maker_rebate
                );
                <b>if</b>(compute_metadata) \{
                    <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(
                        &<b>mut</b> matched_order_metadata,
                        <Link to="clob_v2#0xdee9_clob_v2_matched_order_metadata">matched_order_metadata</Link>(
                            *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
                            account_owner(account_cap),
                            maker_order,
                            filled_base_quantity,
                            // taker_commission = filled_quote_quantity - filled_quote_quantity_without_commission
                            // This guarantees that the subtraction will not underflow
                            filled_quote_quantity - filled_quote_quantity_without_commission,
                            maker_rebate
                        )
                    );
                };
            };

            <b>if</b> (skip_order || maker_base_quantity == 0) \{
                // Remove the maker order.
                <b>let</b> old_order_id = order_id;
                <b>let</b> maybe_order_id = <Link to="../iota-framework/linked_table#0x2_linked_table_next">linked_table::next</Link>(&tick_level.open_orders, order_id);
                <b>if</b> (!<Link to="../move-stdlib/option#0x1_option_is_none">option::is_none</Link>(maybe_order_id)) \{
                    order_id = *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(maybe_order_id);
                };
                <b>let</b> usr_open_order_ids = <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> pool.usr_open_orders, maker_order.owner);
                <Link to="../iota-framework/linked_table#0x2_linked_table_remove">linked_table::remove</Link>(usr_open_order_ids, old_order_id);
                <Link to="../iota-framework/linked_table#0x2_linked_table_remove">linked_table::remove</Link>(&<b>mut</b> tick_level.open_orders, old_order_id);
            } <b>else</b> \{
                // Update the maker order.
                <b>let</b> maker_order_mut = <Link to="../iota-framework/linked_table#0x2_linked_table_borrow_mut">linked_table::borrow_mut</Link>(
                    &<b>mut</b> tick_level.open_orders,
                    order_id);
                maker_order_mut.quantity = maker_base_quantity;
            };
            <b>if</b> (terminate_loop) \{
                <b>break</b>
            };
        };
        <b>if</b> (<Link to="../iota-framework/linked_table#0x2_linked_table_is_empty">linked_table::is_empty</Link>(&tick_level.open_orders)) \{
            (tick_price, _) = next_leaf(all_open_orders, tick_price);
            <Link to="clob_v2#0xdee9_clob_v2_destroy_empty_level">destroy_empty_level</Link>(remove_leaf_by_index(all_open_orders, tick_index));
            (_, tick_index) = find_leaf(all_open_orders, tick_price);
        };
        <b>if</b> (terminate_loop) \{
            <b>break</b>
        };
    };

    <b>if</b> (!<Link to="../move-stdlib/vector#0x1_vector_is_empty">vector::is_empty</Link>(&canceled_order_events)) \{
        <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceled">AllOrdersCanceled</Link>&lt;BaseAsset, QuoteAsset&gt; \{
            pool_id,
            orders_canceled: canceled_order_events,
        });
    };

    <b>return</b> (base_balance_filled, quote_balance_left, <b>if</b>(compute_metadata) <Link to="../move-stdlib/option#0x1_option_some">option::some</Link>(matched_order_metadata) <b>else</b> <Link to="../move-stdlib/option#0x1_option_none">option::none</Link>())
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_match_bid"></Link>

## Function `match_bid`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_match_bid">match_bid</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, client_order_id: u64, quantity: u64, price_limit: u64, current_timestamp: u64, quote_balance: <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;QuoteAsset&gt;, compute_metadata: bool): (<Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;BaseAsset&gt;, <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;QuoteAsset&gt;, <Link to="../move-stdlib/option#0x1_option_Option">option::Option</Link>&lt;<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_match_bid">match_bid</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    account_cap: &AccountCap,
    client_order_id: u64,
    quantity: u64,
    price_limit: u64,
    current_timestamp: u64,
    quote_balance: Balance&lt;QuoteAsset&gt;,
    compute_metadata: bool,
): (Balance&lt;BaseAsset&gt;, Balance&lt;QuoteAsset&gt;, Option&lt;<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;&gt;) \{
    <b>let</b> pool_id = *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id);
    // Base <Link to="../iota-framework/balance#0x2_balance">balance</Link> received by taker.
    // Need <b>to</b> individually keep track of the remaining base quantity <b>to</b> be filled <b>to</b> avoid infinite <b>loop</b>.
    <b>let</b> <b>mut</b> taker_base_quantity_remaining = quantity;
    <b>let</b> <b>mut</b> base_balance_filled = <Link to="../iota-framework/balance#0x2_balance_zero">balance::zero</Link>&lt;BaseAsset&gt;();
    <b>let</b> <b>mut</b> quote_balance_left = quote_balance;
    <b>let</b> all_open_orders = &<b>mut</b> pool.asks;
    <b>let</b> <b>mut</b> matched_order_metadata = <Link to="../move-stdlib/vector#0x1_vector_empty">vector::empty</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;();
    <b>if</b> (<Link to="critbit#0xdee9_critbit_is_empty">critbit::is_empty</Link>(all_open_orders)) \{
        <b>return</b> (base_balance_filled, quote_balance_left, <Link to="../move-stdlib/option#0x1_option_none">option::none</Link>())
    };
    <b>let</b> (<b>mut</b> tick_price, <b>mut</b> tick_index) = min_leaf(all_open_orders);
    <b>let</b> <b>mut</b> canceled_order_events = <Link to="../move-stdlib/vector#0x1_vector">vector</Link>[];

    <b>while</b> (!is_empty&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link>&gt;(all_open_orders) && tick_price &lt;= price_limit) \{
        <b>let</b> tick_level = borrow_mut_leaf_by_index(all_open_orders, tick_index);
        <b>let</b> <b>mut</b> order_id = *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(<Link to="../iota-framework/linked_table#0x2_linked_table_front">linked_table::front</Link>(&tick_level.open_orders));

        <b>while</b> (!<Link to="../iota-framework/linked_table#0x2_linked_table_is_empty">linked_table::is_empty</Link>(&tick_level.open_orders)) \{
            <b>let</b> maker_order = <Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(&tick_level.open_orders, order_id);
            <b>let</b> <b>mut</b> maker_base_quantity = maker_order.quantity;
            <b>let</b> <b>mut</b> skip_order = <b>false</b>;

            <b>if</b> (maker_order.<Link to="clob_v2#0xdee9_clob_v2_expire_timestamp">expire_timestamp</Link> &lt;= current_timestamp || account_owner(account_cap) == maker_order.owner) \{
                skip_order = <b>true</b>;
                <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.base_custodian, maker_order.owner, maker_order.quantity);
                <b>let</b> canceled_order_event = <Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceledComponent">AllOrdersCanceledComponent</Link>&lt;BaseAsset, QuoteAsset&gt; \{
                    client_order_id: maker_order.client_order_id,
                    order_id: maker_order.order_id,
                    is_bid: maker_order.is_bid,
                    owner: maker_order.owner,
                    original_quantity: maker_order.original_quantity,
                    base_asset_quantity_canceled: maker_order.quantity,
                    price: maker_order.price
                };
                <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> canceled_order_events, canceled_order_event);

            } <b>else</b> \{
                <b>let</b> filled_base_quantity =
                    <b>if</b> (taker_base_quantity_remaining &gt; maker_base_quantity) \{ maker_base_quantity }
                    <b>else</b> \{ taker_base_quantity_remaining };
                // Note that <b>if</b> a user creates a pool that allows orders that are too small, this will fail since we cannot have a filled
                // quote quantity of 0.
                <b>let</b> filled_quote_quantity = clob_math::mul(filled_base_quantity, maker_order.price);

                // <b>if</b> maker_rebate = 0 due <b>to</b> underflow, maker will not receive a rebate
                <b>let</b> maker_rebate = clob_math::unsafe_mul(filled_quote_quantity, pool.maker_rebate_rate);
                // <b>if</b> taker_commission = 0 due <b>to</b> underflow, round it up <b>to</b> 1
                <b>let</b> (is_round_down, <b>mut</b> taker_commission) = clob_math::unsafe_mul_round(
                    filled_quote_quantity,
                    pool.taker_fee_rate
                );
                <b>if</b> (is_round_down) taker_commission = taker_commission + 1;

                maker_base_quantity = maker_base_quantity - filled_base_quantity;

                // maker in ask side, decrease maker's locked base asset, increase maker's available quote asset
                taker_base_quantity_remaining = taker_base_quantity_remaining - filled_base_quantity;
                <b>let</b> locked_base_balance = <Link to="custodian#0xdee9_custodian_decrease_user_locked_balance">custodian::decrease_user_locked_balance</Link>&lt;BaseAsset&gt;(
                    &<b>mut</b> pool.base_custodian,
                    maker_order.owner,
                    filled_base_quantity
                );
                <b>let</b> <b>mut</b> taker_commission_balance = <Link to="../iota-framework/balance#0x2_balance_split">balance::split</Link>(
                    &<b>mut</b> quote_balance_left,
                    taker_commission,
                );
                <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>&lt;QuoteAsset&gt;(
                    &<b>mut</b> pool.quote_custodian,
                    maker_order.owner,
                    <Link to="../iota-framework/balance#0x2_balance_split">balance::split</Link>(
                        &<b>mut</b> taker_commission_balance,
                        maker_rebate,
                    ),
                );
                <Link to="../iota-framework/balance#0x2_balance_join">balance::join</Link>(&<b>mut</b> pool.quote_asset_trading_fees, taker_commission_balance);
                <Link to="../iota-framework/balance#0x2_balance_join">balance::join</Link>(&<b>mut</b> base_balance_filled, locked_base_balance);

                <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>&lt;QuoteAsset&gt;(
                    &<b>mut</b> pool.quote_custodian,
                    maker_order.owner,
                    <Link to="../iota-framework/balance#0x2_balance_split">balance::split</Link>(
                        &<b>mut</b> quote_balance_left,
                        filled_quote_quantity,
                    ),
                );

                <Link to="clob_v2#0xdee9_clob_v2_emit_order_filled">emit_order_filled</Link>&lt;BaseAsset, QuoteAsset&gt;(
                    *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
                    client_order_id,
                    account_owner(account_cap),
                    maker_order,
                    filled_base_quantity,
                    taker_commission,
                    maker_rebate
                );
                <b>if</b>(compute_metadata)\{
                    <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(
                        &<b>mut</b> matched_order_metadata,
                        <Link to="clob_v2#0xdee9_clob_v2_matched_order_metadata">matched_order_metadata</Link>(
                            *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
                            account_owner(account_cap),
                            maker_order,
                            filled_base_quantity,
                            taker_commission,
                            maker_rebate
                        )
                    );
                };
            };

            <b>if</b> (skip_order || maker_base_quantity == 0) \{
                // Remove the maker order.
                <b>let</b> old_order_id = order_id;
                <b>let</b> maybe_order_id = <Link to="../iota-framework/linked_table#0x2_linked_table_next">linked_table::next</Link>(&tick_level.open_orders, order_id);
                <b>if</b> (!<Link to="../move-stdlib/option#0x1_option_is_none">option::is_none</Link>(maybe_order_id)) \{
                    order_id = *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(maybe_order_id);
                };
                <b>let</b> usr_open_order_ids = <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> pool.usr_open_orders, maker_order.owner);
                <Link to="../iota-framework/linked_table#0x2_linked_table_remove">linked_table::remove</Link>(usr_open_order_ids, old_order_id);
                <Link to="../iota-framework/linked_table#0x2_linked_table_remove">linked_table::remove</Link>(&<b>mut</b> tick_level.open_orders, old_order_id);
            } <b>else</b> \{
                // Update the maker order.
                <b>let</b> maker_order_mut = <Link to="../iota-framework/linked_table#0x2_linked_table_borrow_mut">linked_table::borrow_mut</Link>(
                    &<b>mut</b> tick_level.open_orders,
                    order_id);
                maker_order_mut.quantity = maker_base_quantity;
            };
            <b>if</b> (taker_base_quantity_remaining == 0) \{
                <b>break</b>
            };
        };
        <b>if</b> (<Link to="../iota-framework/linked_table#0x2_linked_table_is_empty">linked_table::is_empty</Link>(&tick_level.open_orders)) \{
            (tick_price, _) = next_leaf(all_open_orders, tick_price);
            <Link to="clob_v2#0xdee9_clob_v2_destroy_empty_level">destroy_empty_level</Link>(remove_leaf_by_index(all_open_orders, tick_index));
            (_, tick_index) = find_leaf(all_open_orders, tick_price);
        };
        <b>if</b> (taker_base_quantity_remaining == 0) \{
            <b>break</b>
        };
    };

    <b>if</b> (!<Link to="../move-stdlib/vector#0x1_vector_is_empty">vector::is_empty</Link>(&canceled_order_events)) \{
        <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceled">AllOrdersCanceled</Link>&lt;BaseAsset, QuoteAsset&gt; \{
            pool_id,
            orders_canceled: canceled_order_events,
        });
    };
    <b>return</b> (base_balance_filled, quote_balance_left, <b>if</b>(compute_metadata) <Link to="../move-stdlib/option#0x1_option_some">option::some</Link>(matched_order_metadata) <b>else</b> <Link to="../move-stdlib/option#0x1_option_none">option::none</Link>())
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_match_ask"></Link>

## Function `match_ask`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_match_ask">match_ask</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, client_order_id: u64, price_limit: u64, current_timestamp: u64, base_balance: <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;BaseAsset&gt;, compute_metadata: bool): (<Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;BaseAsset&gt;, <Link to="../iota-framework/balance#0x2_balance_Balance">balance::Balance</Link>&lt;QuoteAsset&gt;, <Link to="../move-stdlib/option#0x1_option_Option">option::Option</Link>&lt;<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_match_ask">match_ask</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    account_cap: &AccountCap,
    client_order_id: u64,
    price_limit: u64,
    current_timestamp: u64,
    base_balance: Balance&lt;BaseAsset&gt;,
    compute_metadata: bool,
): (Balance&lt;BaseAsset&gt;, Balance&lt;QuoteAsset&gt;, Option&lt;<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;&gt;) \{
    <b>let</b> pool_id = *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id);
    <b>let</b> <b>mut</b> base_balance_left = base_balance;
    // Base <Link to="../iota-framework/balance#0x2_balance">balance</Link> received by taker, taking into account of taker commission.
    <b>let</b> <b>mut</b> quote_balance_filled = <Link to="../iota-framework/balance#0x2_balance_zero">balance::zero</Link>&lt;QuoteAsset&gt;();
    <b>let</b> all_open_orders = &<b>mut</b> pool.bids;
    <b>let</b> <b>mut</b> matched_order_metadata = <Link to="../move-stdlib/vector#0x1_vector_empty">vector::empty</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;();
    <b>if</b> (<Link to="critbit#0xdee9_critbit_is_empty">critbit::is_empty</Link>(all_open_orders)) \{
        <b>return</b> (base_balance_left, quote_balance_filled, <Link to="../move-stdlib/option#0x1_option_none">option::none</Link>())
    };
    <b>let</b> (<b>mut</b> tick_price, <b>mut</b> tick_index) = max_leaf(all_open_orders);
    <b>let</b> <b>mut</b> canceled_order_events = <Link to="../move-stdlib/vector#0x1_vector">vector</Link>[];
    <b>while</b> (!is_empty&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link>&gt;(all_open_orders) && tick_price &gt;= price_limit) \{
        <b>let</b> tick_level = borrow_mut_leaf_by_index(all_open_orders, tick_index);
        <b>let</b> <b>mut</b> order_id = *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(<Link to="../iota-framework/linked_table#0x2_linked_table_front">linked_table::front</Link>(&tick_level.open_orders));
        <b>while</b> (!<Link to="../iota-framework/linked_table#0x2_linked_table_is_empty">linked_table::is_empty</Link>(&tick_level.open_orders)) \{
            <b>let</b> maker_order = <Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(&tick_level.open_orders, order_id);
            <b>let</b> <b>mut</b> maker_base_quantity = maker_order.quantity;
            <b>let</b> <b>mut</b> skip_order = <b>false</b>;

            <b>if</b> (maker_order.<Link to="clob_v2#0xdee9_clob_v2_expire_timestamp">expire_timestamp</Link> &lt;= current_timestamp || account_owner(account_cap) == maker_order.owner) \{
                skip_order = <b>true</b>;
                <b>let</b> maker_quote_quantity = clob_math::mul(maker_order.quantity, maker_order.price);
                <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.quote_custodian, maker_order.owner, maker_quote_quantity);
                <b>let</b> canceled_order_event = <Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceledComponent">AllOrdersCanceledComponent</Link>&lt;BaseAsset, QuoteAsset&gt; \{
                    client_order_id: maker_order.client_order_id,
                    order_id: maker_order.order_id,
                    is_bid: maker_order.is_bid,
                    owner: maker_order.owner,
                    original_quantity: maker_order.original_quantity,
                    base_asset_quantity_canceled: maker_order.quantity,
                    price: maker_order.price
                };
                <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> canceled_order_events, canceled_order_event);
            } <b>else</b> \{
                <b>let</b> taker_base_quantity_remaining = <Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&base_balance_left);
                <b>let</b> filled_base_quantity =
                    <b>if</b> (taker_base_quantity_remaining &gt;= maker_base_quantity) \{ maker_base_quantity }
                    <b>else</b> \{ taker_base_quantity_remaining };
                // If a bit is rounded down, the pool will take this <b>as</b> a fee.
                <b>let</b> (is_round_down, filled_quote_quantity) = clob_math::unsafe_mul_round(filled_base_quantity, maker_order.price);
                <b>if</b> (is_round_down) \{
                    <b>let</b> rounded_down_quantity = <Link to="custodian#0xdee9_custodian_decrease_user_locked_balance">custodian::decrease_user_locked_balance</Link>&lt;QuoteAsset&gt;(
                        &<b>mut</b> pool.quote_custodian,
                        maker_order.owner,
                        1
                    );
                    <Link to="../iota-framework/balance#0x2_balance_join">balance::join</Link>(&<b>mut</b> pool.quote_asset_trading_fees, rounded_down_quantity);
                };

                // <b>if</b> maker_rebate = 0 due <b>to</b> underflow, maker will not receive a rebate
                <b>let</b> maker_rebate = clob_math::unsafe_mul(filled_quote_quantity, pool.maker_rebate_rate);
                // <b>if</b> taker_commission = 0 due <b>to</b> underflow, round it up <b>to</b> 1
                <b>let</b> (is_round_down, <b>mut</b> taker_commission) = clob_math::unsafe_mul_round(
                    filled_quote_quantity,
                    pool.taker_fee_rate
                );
                <b>if</b> (is_round_down) taker_commission = taker_commission + 1;

                maker_base_quantity = maker_base_quantity - filled_base_quantity;
                // maker in bid side, decrease maker's locked quote asset, increase maker's available base asset
                <b>let</b> <b>mut</b> locked_quote_balance = <Link to="custodian#0xdee9_custodian_decrease_user_locked_balance">custodian::decrease_user_locked_balance</Link>&lt;QuoteAsset&gt;(
                    &<b>mut</b> pool.quote_custodian,
                    maker_order.owner,
                    filled_quote_quantity
                );
                <b>let</b> <b>mut</b> taker_commission_balance = <Link to="../iota-framework/balance#0x2_balance_split">balance::split</Link>(
                    &<b>mut</b> locked_quote_balance,
                    taker_commission,
                );
                <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>&lt;QuoteAsset&gt;(
                    &<b>mut</b> pool.quote_custodian,
                    maker_order.owner,
                    <Link to="../iota-framework/balance#0x2_balance_split">balance::split</Link>(
                        &<b>mut</b> taker_commission_balance,
                        maker_rebate,
                    ),
                );
                <Link to="../iota-framework/balance#0x2_balance_join">balance::join</Link>(&<b>mut</b> pool.quote_asset_trading_fees, taker_commission_balance);
                <Link to="../iota-framework/balance#0x2_balance_join">balance::join</Link>(&<b>mut</b> quote_balance_filled, locked_quote_balance);

                <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>&lt;BaseAsset&gt;(
                    &<b>mut</b> pool.base_custodian,
                    maker_order.owner,
                    <Link to="../iota-framework/balance#0x2_balance_split">balance::split</Link>(
                        &<b>mut</b> base_balance_left,
                        filled_base_quantity,
                    ),
                );
                <Link to="clob_v2#0xdee9_clob_v2_emit_order_filled">emit_order_filled</Link>&lt;BaseAsset, QuoteAsset&gt;(
                    *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
                    client_order_id,
                    account_owner(account_cap),
                    maker_order,
                    filled_base_quantity,
                    taker_commission,
                    maker_rebate
                );
                <b>if</b>(compute_metadata) \{
                    <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(
                        &<b>mut</b> matched_order_metadata,
                        <Link to="clob_v2#0xdee9_clob_v2_matched_order_metadata">matched_order_metadata</Link>(
                            *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
                            account_owner(account_cap),
                            maker_order,
                            filled_base_quantity,
                            taker_commission,
                            maker_rebate
                        )
                    );
                }
            };

            <b>if</b> (skip_order || maker_base_quantity == 0) \{
                // Remove the maker order.
                <b>let</b> old_order_id = order_id;
                <b>let</b> maybe_order_id = <Link to="../iota-framework/linked_table#0x2_linked_table_next">linked_table::next</Link>(&tick_level.open_orders, order_id);
                <b>if</b> (!<Link to="../move-stdlib/option#0x1_option_is_none">option::is_none</Link>(maybe_order_id)) \{
                    order_id = *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(maybe_order_id);
                };
                <b>let</b> usr_open_order_ids = <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> pool.usr_open_orders, maker_order.owner);
                <Link to="../iota-framework/linked_table#0x2_linked_table_remove">linked_table::remove</Link>(usr_open_order_ids, old_order_id);
                <Link to="../iota-framework/linked_table#0x2_linked_table_remove">linked_table::remove</Link>(&<b>mut</b> tick_level.open_orders, old_order_id);
            } <b>else</b> \{
                // Update the maker order.
                <b>let</b> maker_order_mut = <Link to="../iota-framework/linked_table#0x2_linked_table_borrow_mut">linked_table::borrow_mut</Link>(
                    &<b>mut</b> tick_level.open_orders,
                    order_id);
                maker_order_mut.quantity = maker_base_quantity;
            };
            <b>if</b> (<Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&base_balance_left) == 0) \{
                <b>break</b>
            };
        };
        <b>if</b> (<Link to="../iota-framework/linked_table#0x2_linked_table_is_empty">linked_table::is_empty</Link>(&tick_level.open_orders)) \{
            (tick_price, _) = previous_leaf(all_open_orders, tick_price);
            <Link to="clob_v2#0xdee9_clob_v2_destroy_empty_level">destroy_empty_level</Link>(remove_leaf_by_index(all_open_orders, tick_index));
            (_, tick_index) = find_leaf(all_open_orders, tick_price);
        };
        <b>if</b> (<Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&base_balance_left) == 0) \{
            <b>break</b>
        };
    };

    <b>if</b> (!<Link to="../move-stdlib/vector#0x1_vector_is_empty">vector::is_empty</Link>(&canceled_order_events)) \{
        <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceled">AllOrdersCanceled</Link>&lt;BaseAsset, QuoteAsset&gt; \{
            pool_id,
            orders_canceled: canceled_order_events,
        });
    };

    <b>return</b> (base_balance_left, quote_balance_filled, <b>if</b>(compute_metadata) <Link to="../move-stdlib/option#0x1_option_some">option::some</Link>(matched_order_metadata) <b>else</b> <Link to="../move-stdlib/option#0x1_option_none">option::none</Link>())
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_place_market_order"></Link>

## Function `place_market_order`

Place a market order to the order book.


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_market_order">place_market_order</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, client_order_id: u64, quantity: u64, is_bid: bool, base_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, quote_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (<Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_market_order">place_market_order</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    account_cap: &AccountCap,
    client_order_id: u64,
    quantity: u64,
    is_bid: bool,
    base_coin: Coin&lt;BaseAsset&gt;,
    quote_coin: Coin&lt;QuoteAsset&gt;,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    ctx: &<b>mut</b> TxContext,
): (Coin&lt;BaseAsset&gt;, Coin&lt;QuoteAsset&gt;) \{
    <b>let</b> (base_coin, quote_coin, _metadata) = <Link to="clob_v2#0xdee9_clob_v2_place_market_order_int">place_market_order_int</Link>(
        pool,
        account_cap,
        client_order_id,
        quantity,
        is_bid,
        base_coin,
        quote_coin,
        <Link to="../iota-framework/clock#0x2_clock">clock</Link>,
        <b>false</b>, // don't <b>return</b> metadata
        ctx
    );
    (base_coin, quote_coin)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_place_market_order_with_metadata"></Link>

## Function `place_market_order_with_metadata`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_market_order_with_metadata">place_market_order_with_metadata</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, client_order_id: u64, quantity: u64, is_bid: bool, base_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, quote_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (<Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_market_order_with_metadata">place_market_order_with_metadata</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    account_cap: &AccountCap,
    client_order_id: u64,
    quantity: u64,
    is_bid: bool,
    base_coin: Coin&lt;BaseAsset&gt;,
    quote_coin: Coin&lt;QuoteAsset&gt;,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    ctx: &<b>mut</b> TxContext,
): (Coin&lt;BaseAsset&gt;, Coin&lt;QuoteAsset&gt;, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;) \{
    <b>let</b> (base_coin, quote_coin, <b>mut</b> metadata) = <Link to="clob_v2#0xdee9_clob_v2_place_market_order_int">place_market_order_int</Link>(
        pool,
        account_cap,
        client_order_id,
        quantity,
        is_bid,
        base_coin,
        quote_coin,
        <Link to="../iota-framework/clock#0x2_clock">clock</Link>,
        <b>true</b>, // <b>return</b> metadata
        ctx
    );
    (base_coin, quote_coin, <Link to="../move-stdlib/option#0x1_option_extract">option::extract</Link>(&<b>mut</b> metadata))
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_place_market_order_int"></Link>

## Function `place_market_order_int`

Place a market order to the order book.


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_market_order_int">place_market_order_int</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, client_order_id: u64, quantity: u64, is_bid: bool, base_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, quote_coin: <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, compute_metadata: bool, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (<Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;BaseAsset&gt;, <Link to="../iota-framework/coin#0x2_coin_Coin">coin::Coin</Link>&lt;QuoteAsset&gt;, <Link to="../move-stdlib/option#0x1_option_Option">option::Option</Link>&lt;<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_market_order_int">place_market_order_int</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    account_cap: &AccountCap,
    client_order_id: u64,
    quantity: u64,
    is_bid: bool,
    <b>mut</b> base_coin: Coin&lt;BaseAsset&gt;,
    <b>mut</b> quote_coin: Coin&lt;QuoteAsset&gt;,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    compute_metadata: bool,
    ctx: &<b>mut</b> TxContext,
): (Coin&lt;BaseAsset&gt;, Coin&lt;QuoteAsset&gt;, Option&lt;<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;&gt;) \{
    // If market bid order, match against the open ask orders. Otherwise, match against the open bid orders.
    // Take market bid order for example.
    // We first retrieve the PriceLevel <b>with</b> the lowest price by calling min_leaf on the asks Critbit Tree.
    // We then match the market order by iterating through open orders on that price level in ascending order of the order id.
    // Open orders that are being filled are removed from the order book.
    // We stop the iteration until all quantities are filled.
    // If the total quantity of open orders at the lowest price level is not large enough <b>to</b> fully fill the market order,
    // we <b>move</b> on <b>to</b> the next price level by calling next_leaf on the asks Critbit Tree and repeat the same procedure.
    // Continue iterating over the price levels in ascending order until the market order is completely filled.
    // If their market order cannot be completely filled even after consuming all the open ask orders,
    // the unfilled quantity will be cancelled.
    // Market ask order follows similar procedure.
    // The difference is that market ask order is matched against the open bid orders.
    // We start <b>with</b> the bid PriceLevel <b>with</b> the highest price by calling max_leaf on the bids Critbit Tree.
    // The inner <b>loop</b> for iterating over the open orders in ascending orders of order id is the same <b>as</b> above.
    // Then iterate over the price levels in descending order until the market order is completely filled.
    <b>assert</b>!(quantity % pool.lot_size == 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidQuantity">EInvalidQuantity</Link>);
    <b>assert</b>!(quantity != 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidQuantity">EInvalidQuantity</Link>);
    <b>let</b> metadata;
    <b>if</b> (is_bid) \{
        <b>let</b> (base_balance_filled, quote_balance_left, matched_order_metadata) = <Link to="clob_v2#0xdee9_clob_v2_match_bid">match_bid</Link>(
            pool,
            account_cap,
            client_order_id,
            quantity,
            <Link to="clob_v2#0xdee9_clob_v2_MAX_PRICE">MAX_PRICE</Link>,
            <Link to="../iota-framework/clock#0x2_clock_timestamp_ms">clock::timestamp_ms</Link>(<Link to="../iota-framework/clock#0x2_clock">clock</Link>),
            <Link to="../iota-framework/coin#0x2_coin_into_balance">coin::into_balance</Link>(quote_coin),
            compute_metadata
        );
        join(
            &<b>mut</b> base_coin,
            <Link to="../iota-framework/coin#0x2_coin_from_balance">coin::from_balance</Link>(base_balance_filled, ctx),
        );
        quote_coin = <Link to="../iota-framework/coin#0x2_coin_from_balance">coin::from_balance</Link>(quote_balance_left, ctx);
        metadata = matched_order_metadata;
    } <b>else</b> \{
        <b>assert</b>!(<Link to="clob_v2#0xdee9_clob_v2_quantity">quantity</Link> &lt;= <Link to="../iota-framework/coin#0x2_coin_value">coin::value</Link>(&base_coin), <Link to="clob_v2#0xdee9_clob_v2_EInsufficientBaseCoin">EInsufficientBaseCoin</Link>);
        <b>let</b> base_coin_to_sell = <Link to="../iota-framework/coin#0x2_coin_split">coin::split</Link>(&<b>mut</b> base_coin, quantity, ctx);
        <b>let</b> (base_balance_left, quote_balance_filled, matched_order_metadata) = <Link to="clob_v2#0xdee9_clob_v2_match_ask">match_ask</Link>(
            pool,
            account_cap,
            client_order_id,
            <Link to="clob_v2#0xdee9_clob_v2_MIN_PRICE">MIN_PRICE</Link>,
            <Link to="../iota-framework/clock#0x2_clock_timestamp_ms">clock::timestamp_ms</Link>(<Link to="../iota-framework/clock#0x2_clock">clock</Link>),
            <Link to="../iota-framework/coin#0x2_coin_into_balance">coin::into_balance</Link>(base_coin_to_sell),
            compute_metadata
        );
        join(
            &<b>mut</b> base_coin,
            <Link to="../iota-framework/coin#0x2_coin_from_balance">coin::from_balance</Link>(base_balance_left, ctx));
        join(
            &<b>mut</b> quote_coin,
            <Link to="../iota-framework/coin#0x2_coin_from_balance">coin::from_balance</Link>(quote_balance_filled, ctx),
        );
        metadata = matched_order_metadata;
    };
    (base_coin, quote_coin, metadata)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_inject_limit_order"></Link>

## Function `inject_limit_order`

Injects a maker order to the order book.
Returns the order id.


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_inject_limit_order">inject_limit_order</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, client_order_id: u64, price: u64, original_quantity: u64, quantity: u64, is_bid: bool, self_matching_prevention: u8, expire_timestamp: u64, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_inject_limit_order">inject_limit_order</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    client_order_id: u64,
    price: u64,
    original_quantity: u64,
    quantity: u64,
    is_bid: bool,
    self_matching_prevention: u8,
    expire_timestamp: u64,
    account_cap: &AccountCap,
    ctx: &<b>mut</b> TxContext
): u64 \{
    <b>let</b> owner = account_owner(account_cap);
    <b>let</b> order_id: u64;
    <b>let</b> open_orders: &<b>mut</b> CritbitTree&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link>&gt;;
    <b>if</b> (is_bid) \{
        <b>let</b> quote_quantity = clob_math::mul(quantity, price);
        <Link to="custodian#0xdee9_custodian_lock_balance">custodian::lock_balance</Link>&lt;QuoteAsset&gt;(&<b>mut</b> pool.quote_custodian, account_cap, quote_quantity);
        order_id = pool.next_bid_order_id;
        pool.next_bid_order_id = pool.next_bid_order_id + 1;
        open_orders = &<b>mut</b> pool.bids;
    } <b>else</b> \{
        <Link to="custodian#0xdee9_custodian_lock_balance">custodian::lock_balance</Link>&lt;BaseAsset&gt;(&<b>mut</b> pool.base_custodian, account_cap, quantity);
        order_id = pool.next_ask_order_id;
        pool.next_ask_order_id = pool.next_ask_order_id + 1;
        open_orders = &<b>mut</b> pool.asks;
    };
    <b>let</b> order = <Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link> \{
        order_id,
        client_order_id,
        price,
        original_quantity,
        quantity,
        is_bid,
        owner,
        expire_timestamp,
        self_matching_prevention
    };
    <b>let</b> (tick_exists, <b>mut</b> tick_index) = find_leaf(open_orders, price);
    <b>if</b> (!tick_exists) \{
        tick_index = insert_leaf(
            open_orders,
            price,
            <Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link> \{
                price,
                open_orders: <Link to="../iota-framework/linked_table#0x2_linked_table_new">linked_table::new</Link>(ctx),
            });
    };

    <b>let</b> tick_level = borrow_mut_leaf_by_index(open_orders, tick_index);
    <Link to="../iota-framework/linked_table#0x2_linked_table_push_back">linked_table::push_back</Link>(&<b>mut</b> tick_level.open_orders, order_id, order);
    <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_OrderPlaced">OrderPlaced</Link>&lt;BaseAsset, QuoteAsset&gt; \{
        pool_id: *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id),
        order_id,
        client_order_id,
        is_bid,
        owner,
        original_quantity,
        base_asset_quantity_placed: quantity,
        price,
        expire_timestamp
    });
    <b>if</b> (!contains(&pool.usr_open_orders, owner)) \{
        add(&<b>mut</b> pool.usr_open_orders, owner, <Link to="../iota-framework/linked_table#0x2_linked_table_new">linked_table::new</Link>(ctx));
    };
    <Link to="../iota-framework/linked_table#0x2_linked_table_push_back">linked_table::push_back</Link>(borrow_mut(&<b>mut</b> pool.usr_open_orders, owner), order_id, price);

    <b>return</b> order_id
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_place_limit_order"></Link>

## Function `place_limit_order`

Place a limit order to the order book.
Returns (base quantity filled, quote quantity filled, whether a maker order is being placed, order id of the maker order).
When the limit order is not successfully placed, we return false to indicate that and also returns a meaningless order_id 0.
When the limit order is successfully placed, we return true to indicate that and also the corresponding order_id.
So please check that boolean value first before using the order id.


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_limit_order">place_limit_order</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, client_order_id: u64, price: u64, quantity: u64, self_matching_prevention: u8, is_bid: bool, expire_timestamp: u64, restriction: u8, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (u64, u64, bool, u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_limit_order">place_limit_order</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    client_order_id: u64,
    price: u64,
    quantity: u64,
    self_matching_prevention: u8,
    is_bid: bool,
    expire_timestamp: u64, // Expiration timestamp in ms in absolute value inclusive.
    restriction: u8,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    account_cap: &AccountCap,
    ctx: &<b>mut</b> TxContext
): (u64, u64, bool, u64) \{
    <b>let</b> (base_quantity_filled, quote_quantity_filled, is_success, order_id, _meta_data) = <Link to="clob_v2#0xdee9_clob_v2_place_limit_order_int">place_limit_order_int</Link>(
        pool,
        client_order_id,
        price,
        quantity,
        self_matching_prevention,
        is_bid,
        expire_timestamp, // Expiration timestamp in ms in absolute value inclusive.
        restriction,
        <Link to="../iota-framework/clock#0x2_clock">clock</Link>,
        account_cap,
        <b>false</b>, // don't compute metadata
        ctx
    );
    (base_quantity_filled, quote_quantity_filled, is_success, order_id)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_place_limit_order_with_metadata"></Link>

## Function `place_limit_order_with_metadata`

Place a limit order to the order book.
Returns (base quantity filled, quote quantity filled, whether a maker order is being placed, order id of the maker order).
When the limit order is not successfully placed, we return false to indicate that and also returns a meaningless order_id 0.
When the limit order is successfully placed, we return true to indicate that and also the corresponding order_id.
So please check that boolean value first before using the order id.


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_limit_order_with_metadata">place_limit_order_with_metadata</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, client_order_id: u64, price: u64, quantity: u64, self_matching_prevention: u8, is_bid: bool, expire_timestamp: u64, restriction: u8, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (u64, u64, bool, u64, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_limit_order_with_metadata">place_limit_order_with_metadata</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    client_order_id: u64,
    price: u64,
    quantity: u64,
    self_matching_prevention: u8,
    is_bid: bool,
    expire_timestamp: u64, // Expiration timestamp in ms in absolute value inclusive.
    restriction: u8,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    account_cap: &AccountCap,
    ctx: &<b>mut</b> TxContext
): (u64, u64, bool, u64, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;) \{
    <b>let</b> (base_quantity_filled, quote_quantity_filled, is_success, order_id, <b>mut</b> meta_data) = <Link to="clob_v2#0xdee9_clob_v2_place_limit_order_int">place_limit_order_int</Link>(
        pool,
        client_order_id,
        price,
        quantity,
        self_matching_prevention,
        is_bid,
        expire_timestamp, // Expiration timestamp in ms in absolute value inclusive.
        restriction,
        <Link to="../iota-framework/clock#0x2_clock">clock</Link>,
        account_cap,
        <b>true</b>, // <b>return</b> metadata
        ctx
    );
    (base_quantity_filled, quote_quantity_filled, is_success, order_id, <Link to="../move-stdlib/option#0x1_option_extract">option::extract</Link>(&<b>mut</b> meta_data))
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_place_limit_order_int"></Link>

## Function `place_limit_order_int`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_limit_order_int">place_limit_order_int</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, client_order_id: u64, price: u64, quantity: u64, self_matching_prevention: u8, is_bid: bool, expire_timestamp: u64, restriction: u8, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>, compute_metadata: bool, ctx: &<b>mut</b> <Link to="../iota-framework/tx_context#0x2_tx_context_TxContext">tx_context::TxContext</Link>): (u64, u64, bool, u64, <Link to="../move-stdlib/option#0x1_option_Option">option::Option</Link>&lt;<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_place_limit_order_int">place_limit_order_int</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    client_order_id: u64,
    price: u64,
    quantity: u64,
    self_matching_prevention: u8,
    is_bid: bool,
    expire_timestamp: u64, // Expiration timestamp in ms in absolute value inclusive.
    restriction: u8,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    account_cap: &AccountCap,
    compute_metadata: bool,
    ctx: &<b>mut</b> TxContext
): (u64, u64, bool, u64, Option&lt;<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;&gt;&gt;) \{
    // If limit bid order, check whether the price is lower than the lowest ask order by checking the min_leaf of asks Critbit Tree.
    // If so, assign the sequence id of the order <b>to</b> be next_bid_order_id and increment next_bid_order_id by 1.
    // Inject the new order <b>to</b> the bids Critbit Tree according <b>to</b> the price and order id.
    // Otherwise, find the price level from the asks Critbit Tree that is no greater than the input price.
    // Match the bid order against the asks Critbit Tree in the same way <b>as</b> a market order but up until the price level found in the previous step.
    // If the bid order is not completely filled, inject the remaining quantity <b>to</b> the bids Critbit Tree according <b>to</b> the input price and order id.
    // If limit ask order, vice versa.
    <b>assert</b>!(self_matching_prevention == <Link to="clob_v2#0xdee9_clob_v2_CANCEL_OLDEST">CANCEL_OLDEST</Link>, <Link to="clob_v2#0xdee9_clob_v2_EInvalidSelfMatchingPreventionArg">EInvalidSelfMatchingPreventionArg</Link>);
    <b>assert</b>!(quantity &gt; 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidQuantity">EInvalidQuantity</Link>);
    <b>assert</b>!(price &gt; 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidPrice">EInvalidPrice</Link>);
    <b>assert</b>!(price % pool.tick_size == 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidPrice">EInvalidPrice</Link>);
    <b>assert</b>!(quantity % pool.lot_size == 0, <Link to="clob_v2#0xdee9_clob_v2_EInvalidQuantity">EInvalidQuantity</Link>);
    <b>assert</b>!(expire_timestamp &gt; <Link to="../iota-framework/clock#0x2_clock_timestamp_ms">clock::timestamp_ms</Link>(<Link to="../iota-framework/clock#0x2_clock">clock</Link>), <Link to="clob_v2#0xdee9_clob_v2_EInvalidExpireTimestamp">EInvalidExpireTimestamp</Link>);
    <b>let</b> owner = account_owner(account_cap);
    <b>let</b> original_quantity = quantity;
    <b>let</b> base_quantity_filled;
    <b>let</b> quote_quantity_filled;
    <b>let</b> meta_data = <b>if</b> (is_bid) \{
        <b>let</b> quote_quantity_original = <Link to="custodian#0xdee9_custodian_account_available_balance">custodian::account_available_balance</Link>&lt;QuoteAsset&gt;(
            &pool.quote_custodian,
            owner
        );
        <b>let</b> quote_balance = <Link to="custodian#0xdee9_custodian_decrease_user_available_balance">custodian::decrease_user_available_balance</Link>&lt;QuoteAsset&gt;(
            &<b>mut</b> pool.quote_custodian,
            account_cap,
            quote_quantity_original,
        );
        <b>let</b> (base_balance_filled, quote_balance_left, matched_order_metadata) = <Link to="clob_v2#0xdee9_clob_v2_match_bid">match_bid</Link>(
            pool,
            account_cap,
            client_order_id,
            quantity,
            price,
            <Link to="../iota-framework/clock#0x2_clock_timestamp_ms">clock::timestamp_ms</Link>(<Link to="../iota-framework/clock#0x2_clock">clock</Link>),
            quote_balance,
            compute_metadata
        );
        base_quantity_filled = <Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&base_balance_filled);
        quote_quantity_filled = quote_quantity_original - <Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&quote_balance_left);

        <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>&lt;BaseAsset&gt;(
            &<b>mut</b> pool.base_custodian,
            owner,
            base_balance_filled,
        );
        <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>&lt;QuoteAsset&gt;(
            &<b>mut</b> pool.quote_custodian,
            owner,
            quote_balance_left,
        );

        matched_order_metadata
    } <b>else</b> \{
        <b>let</b> base_balance = <Link to="custodian#0xdee9_custodian_decrease_user_available_balance">custodian::decrease_user_available_balance</Link>&lt;BaseAsset&gt;(
            &<b>mut</b> pool.base_custodian,
            account_cap,
            quantity,
        );
        <b>let</b> (base_balance_left, quote_balance_filled, matched_order_metadata) = <Link to="clob_v2#0xdee9_clob_v2_match_ask">match_ask</Link>(
            pool,
            account_cap,
            client_order_id,
            price,
            <Link to="../iota-framework/clock#0x2_clock_timestamp_ms">clock::timestamp_ms</Link>(<Link to="../iota-framework/clock#0x2_clock">clock</Link>),
            base_balance,
            compute_metadata
        );

        base_quantity_filled = quantity - <Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&base_balance_left);
        quote_quantity_filled = <Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&quote_balance_filled);

        <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>&lt;BaseAsset&gt;(
            &<b>mut</b> pool.base_custodian,
            owner,
            base_balance_left,
        );
        <Link to="custodian#0xdee9_custodian_increase_user_available_balance">custodian::increase_user_available_balance</Link>&lt;QuoteAsset&gt;(
            &<b>mut</b> pool.quote_custodian,
            owner,
            quote_balance_filled,
        );
        matched_order_metadata
    };

    <b>let</b> order_id;
    <b>if</b> (restriction == <Link to="clob_v2#0xdee9_clob_v2_IMMEDIATE_OR_CANCEL">IMMEDIATE_OR_CANCEL</Link>) \{
        <b>return</b> (base_quantity_filled, quote_quantity_filled, <b>false</b>, 0, meta_data)
    };
    <b>if</b> (restriction == <Link to="clob_v2#0xdee9_clob_v2_FILL_OR_KILL">FILL_OR_KILL</Link>) \{
        <b>assert</b>!(base_quantity_filled == quantity, <Link to="clob_v2#0xdee9_clob_v2_EOrderCannotBeFullyFilled">EOrderCannotBeFullyFilled</Link>);
        <b>return</b> (base_quantity_filled, quote_quantity_filled, <b>false</b>, 0, meta_data)
    };
    <b>if</b> (restriction == <Link to="clob_v2#0xdee9_clob_v2_POST_OR_ABORT">POST_OR_ABORT</Link>) \{
        <b>assert</b>!(base_quantity_filled == 0, <Link to="clob_v2#0xdee9_clob_v2_EOrderCannotBeFullyPassive">EOrderCannotBeFullyPassive</Link>);
        order_id = <Link to="clob_v2#0xdee9_clob_v2_inject_limit_order">inject_limit_order</Link>(
            pool,
            client_order_id,
            price,
            original_quantity,
            quantity,
            is_bid,
            self_matching_prevention,
            expire_timestamp,
            account_cap,
            ctx
        );
        <b>return</b> (base_quantity_filled, quote_quantity_filled, <b>true</b>, order_id, meta_data)
    } <b>else</b> \{
        <b>assert</b>!(restriction == <Link to="clob_v2#0xdee9_clob_v2_NO_RESTRICTION">NO_RESTRICTION</Link>, <Link to="clob_v2#0xdee9_clob_v2_EInvalidRestriction">EInvalidRestriction</Link>);
        <b>if</b> (quantity &gt; base_quantity_filled) \{
            order_id = <Link to="clob_v2#0xdee9_clob_v2_inject_limit_order">inject_limit_order</Link>(
                pool,
                client_order_id,
                price,
                original_quantity,
                quantity - base_quantity_filled,
                is_bid,
                self_matching_prevention,
                expire_timestamp,
                account_cap,
                ctx
            );
            <b>return</b> (base_quantity_filled, quote_quantity_filled, <b>true</b>, order_id, meta_data)
        };
        <b>return</b> (base_quantity_filled, quote_quantity_filled, <b>false</b>, 0, meta_data)
    }
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_order_is_bid"></Link>

## Function `order_is_bid`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_order_is_bid">order_is_bid</Link>(order_id: u64): bool
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_order_is_bid">order_is_bid</Link>(order_id: u64): bool \{
    <b>return</b> <Link to="clob_v2#0xdee9_clob_v2_order_id">order_id</Link> &lt; <Link to="clob_v2#0xdee9_clob_v2_MIN_ASK_ORDER_ID">MIN_ASK_ORDER_ID</Link>
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_emit_order_canceled"></Link>

## Function `emit_order_canceled`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_emit_order_canceled">emit_order_canceled</Link>&lt;BaseAsset, QuoteAsset&gt;(pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link>, order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_emit_order_canceled">emit_order_canceled</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool_id: ID,
    order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>
) \{
    <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_OrderCanceled">OrderCanceled</Link>&lt;BaseAsset, QuoteAsset&gt; \{
        pool_id,
        client_order_id: order.client_order_id,
        order_id: order.order_id,
        is_bid: order.is_bid,
        owner: order.owner,
        original_quantity: order.original_quantity,
        base_asset_quantity_canceled: order.quantity,
        price: order.price
    })
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_emit_order_filled"></Link>

## Function `emit_order_filled`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_emit_order_filled">emit_order_filled</Link>&lt;BaseAsset, QuoteAsset&gt;(pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link>, taker_client_id: u64, taker_address: <b>address</b>, order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>, base_asset_quantity_filled: u64, taker_commission: u64, maker_rebates: u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_emit_order_filled">emit_order_filled</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool_id: ID,
    taker_client_id: u64,
    taker_address: <b>address</b>,
    order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>,
    base_asset_quantity_filled: u64,
    taker_commission: u64,
    maker_rebates: u64
) \{
    <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_OrderFilled">OrderFilled</Link>&lt;BaseAsset, QuoteAsset&gt; \{
        pool_id,
        order_id: order.order_id,
        taker_client_order_id: taker_client_id,
        taker_address,
        maker_client_order_id: order.client_order_id,
        is_bid: order.is_bid,
        maker_address: order.owner,
        original_quantity: order.original_quantity,
        base_asset_quantity_filled,
        // order.quantity = base_asset_quantity_filled + base_asset_quantity_remaining
        // This guarantees that the subtraction will not underflow
        base_asset_quantity_remaining: order.quantity - base_asset_quantity_filled,
        price: order.price,
        taker_commission,
        maker_rebates
    })
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_cancel_order"></Link>

## Function `cancel_order`

Cancel and opening order.
Abort if order_id is invalid or if the order is not submitted by the transaction sender.


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_cancel_order">cancel_order</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, order_id: u64, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_cancel_order">cancel_order</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    order_id: u64,
    account_cap: &AccountCap
) \{
    // First check the highest bit of the order id <b>to</b> see whether it's bid or ask.
    // Then retrieve the price using the order id.
    // Using the price <b>to</b> retrieve the corresponding PriceLevel from the bids / asks Critbit Tree.
    // Retrieve and remove the order from open orders of the PriceLevel.
    <b>let</b> owner = account_owner(account_cap);
    <b>assert</b>!(contains(&pool.usr_open_orders, owner), <Link to="clob_v2#0xdee9_clob_v2_EInvalidUser">EInvalidUser</Link>);
    <b>let</b> usr_open_orders = borrow_mut(&<b>mut</b> pool.usr_open_orders, owner);
    <b>assert</b>!(<Link to="../iota-framework/linked_table#0x2_linked_table_contains">linked_table::contains</Link>(usr_open_orders, order_id), <Link to="clob_v2#0xdee9_clob_v2_EInvalidOrderId">EInvalidOrderId</Link>);
    <b>let</b> tick_price = *<Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(usr_open_orders, order_id);
    <b>let</b> is_bid = <Link to="clob_v2#0xdee9_clob_v2_order_is_bid">order_is_bid</Link>(order_id);
    <b>let</b> (tick_exists, tick_index) = find_leaf(
        <b>if</b> (is_bid) \{ &pool.bids } <b>else</b> \{ &pool.asks },
        tick_price);
    <b>assert</b>!(tick_exists, <Link to="clob_v2#0xdee9_clob_v2_EInvalidOrderId">EInvalidOrderId</Link>);
    <b>let</b> order = <Link to="clob_v2#0xdee9_clob_v2_remove_order">remove_order</Link>(
        <b>if</b> (is_bid) \{ &<b>mut</b> pool.bids } <b>else</b> \{ &<b>mut</b> pool.asks },
        usr_open_orders,
        tick_index,
        order_id,
        owner
    );
    <b>if</b> (is_bid) \{
        <b>let</b> (_, balance_locked) = clob_math::unsafe_mul_round(order.quantity, order.price);
        <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.quote_custodian, owner, balance_locked);
    } <b>else</b> \{
        <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.base_custodian, owner, order.quantity);
    };
    <Link to="clob_v2#0xdee9_clob_v2_emit_order_canceled">emit_order_canceled</Link>&lt;BaseAsset, QuoteAsset&gt;(*<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id), &order);
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_remove_order"></Link>

## Function `remove_order`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_remove_order">remove_order</Link>(open_orders: &<b>mut</b> <Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">clob_v2::TickLevel</Link>&gt;, usr_open_orders: &<b>mut</b> <Link to="../iota-framework/linked_table#0x2_linked_table_LinkedTable">linked_table::LinkedTable</Link>&lt;u64, u64&gt;, tick_index: u64, order_id: u64, owner: <b>address</b>): <Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_remove_order">remove_order</Link>(
    open_orders: &<b>mut</b> CritbitTree&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link>&gt;,
    usr_open_orders: &<b>mut</b> LinkedTable&lt;u64, u64&gt;,
    tick_index: u64,
    order_id: u64,
    owner: <b>address</b>,
): <Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link> \{
    <Link to="../iota-framework/linked_table#0x2_linked_table_remove">linked_table::remove</Link>(usr_open_orders, order_id);
    <b>let</b> tick_level = borrow_leaf_by_index(open_orders, tick_index);
    <b>assert</b>!(<Link to="../iota-framework/linked_table#0x2_linked_table_contains">linked_table::contains</Link>(&tick_level.open_orders, order_id), <Link to="clob_v2#0xdee9_clob_v2_EInvalidOrderId">EInvalidOrderId</Link>);
    <b>let</b> mut_tick_level = borrow_mut_leaf_by_index(open_orders, tick_index);
    <b>let</b> order = <Link to="../iota-framework/linked_table#0x2_linked_table_remove">linked_table::remove</Link>(&<b>mut</b> mut_tick_level.open_orders, order_id);
    <b>assert</b>!(order.owner == owner, <Link to="clob_v2#0xdee9_clob_v2_EUnauthorizedCancel">EUnauthorizedCancel</Link>);
    <b>if</b> (<Link to="../iota-framework/linked_table#0x2_linked_table_is_empty">linked_table::is_empty</Link>(&mut_tick_level.open_orders)) \{
        <Link to="clob_v2#0xdee9_clob_v2_destroy_empty_level">destroy_empty_level</Link>(remove_leaf_by_index(open_orders, tick_index));
    };
    order
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_cancel_all_orders"></Link>

## Function `cancel_all_orders`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_cancel_all_orders">cancel_all_orders</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_cancel_all_orders">cancel_all_orders</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    account_cap: &AccountCap
) \{
    <b>let</b> pool_id = *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id);
    <b>let</b> owner = account_owner(account_cap);
    <b>assert</b>!(contains(&pool.usr_open_orders, owner), <Link to="clob_v2#0xdee9_clob_v2_EInvalidUser">EInvalidUser</Link>);
    <b>let</b> usr_open_order_ids = <Link to="../iota-framework/table#0x2_table_borrow_mut">table::borrow_mut</Link>(&<b>mut</b> pool.usr_open_orders, owner);
    <b>let</b> <b>mut</b> canceled_order_events = <Link to="../move-stdlib/vector#0x1_vector">vector</Link>[];
    <b>while</b> (!<Link to="../iota-framework/linked_table#0x2_linked_table_is_empty">linked_table::is_empty</Link>(usr_open_order_ids)) \{
        <b>let</b> order_id = *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(<Link to="../iota-framework/linked_table#0x2_linked_table_back">linked_table::back</Link>(usr_open_order_ids));
        <b>let</b> order_price = *<Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(usr_open_order_ids, order_id);
        <b>let</b> is_bid = <Link to="clob_v2#0xdee9_clob_v2_order_is_bid">order_is_bid</Link>(order_id);
        <b>let</b> open_orders =
            <b>if</b> (is_bid) \{ &<b>mut</b> pool.bids }
            <b>else</b> \{ &<b>mut</b> pool.asks };
        <b>let</b> (_, tick_index) = <Link to="critbit#0xdee9_critbit_find_leaf">critbit::find_leaf</Link>(open_orders, order_price);
        <b>let</b> order = <Link to="clob_v2#0xdee9_clob_v2_remove_order">remove_order</Link>(
            open_orders,
            usr_open_order_ids,
            tick_index,
            order_id,
            owner
        );
        <b>if</b> (is_bid) \{
            <b>let</b> (_, balance_locked) = clob_math::unsafe_mul_round(order.quantity, order.price);
            <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.quote_custodian, owner, balance_locked);
        } <b>else</b> \{
            <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.base_custodian, owner, order.quantity);
        };
        <b>let</b> canceled_order_event = <Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceledComponent">AllOrdersCanceledComponent</Link>&lt;BaseAsset, QuoteAsset&gt; \{
            client_order_id: order.client_order_id,
            order_id: order.order_id,
            is_bid: order.is_bid,
            owner: order.owner,
            original_quantity: order.original_quantity,
            base_asset_quantity_canceled: order.quantity,
            price: order.price
        };

        <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> canceled_order_events, canceled_order_event);
    };

    <b>if</b> (!<Link to="../move-stdlib/vector#0x1_vector_is_empty">vector::is_empty</Link>(&canceled_order_events)) \{
        <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceled">AllOrdersCanceled</Link>&lt;BaseAsset, QuoteAsset&gt; \{
            pool_id,
            orders_canceled: canceled_order_events,
        });
    };
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_batch_cancel_order"></Link>

## Function `batch_cancel_order`

Batch cancel limit orders to save gas cost.
Abort if any of the order_ids are not submitted by the sender.
Skip any order_id that is invalid.
Note that this function can reduce gas cost even further if caller has multiple orders at the same price level,
and if orders with the same price are grouped together in the vector.
For example, if we have the following order_id to price mapping, \{0: 100., 1: 200., 2: 100., 3: 200.}.
Grouping order_ids like [0, 2, 1, 3] would make it the most gas efficient.


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_batch_cancel_order">batch_cancel_order</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, order_ids: <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_batch_cancel_order">batch_cancel_order</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    order_ids: <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;,
    account_cap: &AccountCap
) \{
    <b>let</b> pool_id = *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id);
    // First group the order ids according <b>to</b> price level,
    // so that we don't have <b>to</b> retrieve the PriceLevel multiple times <b>if</b> there are orders at the same price level.
    // Iterate over each price level, retrieve the corresponding PriceLevel.
    // Iterate over the order ids that need <b>to</b> be canceled at that price level,
    // retrieve and remove the order from open orders of the PriceLevel.
    <b>let</b> owner = account_owner(account_cap);
    <b>assert</b>!(contains(&pool.usr_open_orders, owner), 0);
    <b>let</b> <b>mut</b> tick_index: u64 = 0;
    <b>let</b> <b>mut</b> tick_price: u64 = 0;
    <b>let</b> n_order = <Link to="../move-stdlib/vector#0x1_vector_length">vector::length</Link>(&order_ids);
    <b>let</b> <b>mut</b> i_order = 0;
    <b>let</b> usr_open_orders = borrow_mut(&<b>mut</b> pool.usr_open_orders, owner);
    <b>let</b> <b>mut</b> canceled_order_events = <Link to="../move-stdlib/vector#0x1_vector">vector</Link>[];

    <b>while</b> (i_order &lt; n_order) \{
        <b>let</b> order_id = *<Link to="../move-stdlib/vector#0x1_vector_borrow">vector::borrow</Link>(&order_ids, i_order);
        <b>assert</b>!(<Link to="../iota-framework/linked_table#0x2_linked_table_contains">linked_table::contains</Link>(usr_open_orders, order_id), <Link to="clob_v2#0xdee9_clob_v2_EInvalidOrderId">EInvalidOrderId</Link>);
        <b>let</b> new_tick_price = *<Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(usr_open_orders, order_id);
        <b>let</b> is_bid = <Link to="clob_v2#0xdee9_clob_v2_order_is_bid">order_is_bid</Link>(order_id);
        <b>if</b> (new_tick_price != tick_price) \{
            tick_price = new_tick_price;
            <b>let</b> (tick_exists, new_tick_index) = find_leaf(
                <b>if</b> (is_bid) \{ &pool.bids } <b>else</b> \{ &pool.asks },
                tick_price
            );
            <b>assert</b>!(tick_exists, <Link to="clob_v2#0xdee9_clob_v2_EInvalidTickPrice">EInvalidTickPrice</Link>);
            tick_index = new_tick_index;
        };
        <b>let</b> order = <Link to="clob_v2#0xdee9_clob_v2_remove_order">remove_order</Link>(
            <b>if</b> (is_bid) \{ &<b>mut</b> pool.bids } <b>else</b> \{ &<b>mut</b> pool.asks },
            usr_open_orders,
            tick_index,
            order_id,
            owner
        );
        <b>if</b> (is_bid) \{
            <b>let</b> (_is_round_down, balance_locked) = clob_math::unsafe_mul_round(order.quantity, order.price);
            <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.quote_custodian, owner, balance_locked);
        } <b>else</b> \{
            <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.base_custodian, owner, order.quantity);
        };
        <b>let</b> canceled_order_event = <Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceledComponent">AllOrdersCanceledComponent</Link>&lt;BaseAsset, QuoteAsset&gt; \{
            client_order_id: order.client_order_id,
            order_id: order.order_id,
            is_bid: order.is_bid,
            owner: order.owner,
            original_quantity: order.original_quantity,
            base_asset_quantity_canceled: order.quantity,
            price: order.price
        };
        <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> canceled_order_events, canceled_order_event);

        i_order = i_order + 1;
    };

    <b>if</b> (!<Link to="../move-stdlib/vector#0x1_vector_is_empty">vector::is_empty</Link>(&canceled_order_events)) \{
        <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceled">AllOrdersCanceled</Link>&lt;BaseAsset, QuoteAsset&gt; \{
            pool_id,
            orders_canceled: canceled_order_events,
        });
    };
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_clean_up_expired_orders"></Link>

## Function `clean_up_expired_orders`

Clean up expired orders
Note that this function can reduce gas cost if orders
with the same price are grouped together in the vector because we would not need the computation to find the tick_index.
For example, if we have the following order_id to price mapping, \{0: 100., 1: 200., 2: 100., 3: 200.}.
Grouping order_ids like [0, 2, 1, 3] would make it the most gas efficient.
Order owners should be the owner addresses from the account capacities which placed the orders,
and they should correspond to the order IDs one by one.


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_clean_up_expired_orders">clean_up_expired_orders</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>, order_ids: <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;, order_owners: <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<b>address</b>&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_clean_up_expired_orders">clean_up_expired_orders</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<b>mut</b> <Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock,
    order_ids: <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;,
    order_owners: <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<b>address</b>&gt;
) \{
    <b>let</b> pool_id = *<Link to="../iota-framework/object#0x2_object_uid_as_inner">object::uid_as_inner</Link>(&pool.id);
    <b>let</b> now = <Link to="../iota-framework/clock#0x2_clock_timestamp_ms">clock::timestamp_ms</Link>(<Link to="../iota-framework/clock#0x2_clock">clock</Link>);
    <b>let</b> n_order = <Link to="../move-stdlib/vector#0x1_vector_length">vector::length</Link>(&order_ids);
    <b>assert</b>!(n_order == <Link to="../move-stdlib/vector#0x1_vector_length">vector::length</Link>(&order_owners), <Link to="clob_v2#0xdee9_clob_v2_ENotEqual">ENotEqual</Link>);
    <b>let</b> <b>mut</b> i_order = 0;
    <b>let</b> <b>mut</b> tick_index: u64 = 0;
    <b>let</b> <b>mut</b> tick_price: u64 = 0;
    <b>let</b> <b>mut</b> canceled_order_events = <Link to="../move-stdlib/vector#0x1_vector">vector</Link>[];
    <b>while</b> (i_order &lt; n_order) \{
        <b>let</b> order_id = *<Link to="../move-stdlib/vector#0x1_vector_borrow">vector::borrow</Link>(&order_ids, i_order);
        <b>let</b> owner = *<Link to="../move-stdlib/vector#0x1_vector_borrow">vector::borrow</Link>(&order_owners, i_order);
        <b>if</b> (!<Link to="../iota-framework/table#0x2_table_contains">table::contains</Link>(&pool.usr_open_orders, owner)) \{ <b>continue</b> };
        <b>let</b> usr_open_orders = borrow_mut(&<b>mut</b> pool.usr_open_orders, owner);
        <b>if</b> (!<Link to="../iota-framework/linked_table#0x2_linked_table_contains">linked_table::contains</Link>(usr_open_orders, order_id)) \{ <b>continue</b> };
        <b>let</b> new_tick_price = *<Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(usr_open_orders, order_id);
        <b>let</b> is_bid = <Link to="clob_v2#0xdee9_clob_v2_order_is_bid">order_is_bid</Link>(order_id);
        <b>let</b> open_orders = <b>if</b> (is_bid) \{ &<b>mut</b> pool.bids } <b>else</b> \{ &<b>mut</b> pool.asks };
        <b>if</b> (new_tick_price != tick_price) \{
            tick_price = new_tick_price;
            <b>let</b> (tick_exists, new_tick_index) = find_leaf(
                open_orders,
                tick_price
            );
            <b>assert</b>!(tick_exists, <Link to="clob_v2#0xdee9_clob_v2_EInvalidTickPrice">EInvalidTickPrice</Link>);
            tick_index = new_tick_index;
        };
        <b>let</b> order = <Link to="clob_v2#0xdee9_clob_v2_remove_order">remove_order</Link>(open_orders, usr_open_orders, tick_index, order_id, owner);
        <b>assert</b>!(order.<Link to="clob_v2#0xdee9_clob_v2_expire_timestamp">expire_timestamp</Link> &lt; now, <Link to="clob_v2#0xdee9_clob_v2_EInvalidExpireTimestamp">EInvalidExpireTimestamp</Link>);
        <b>if</b> (is_bid) \{
            <b>let</b> (_is_round_down, balance_locked) = clob_math::unsafe_mul_round(order.quantity, order.price);
            <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.quote_custodian, owner, balance_locked);
        } <b>else</b> \{
            <Link to="custodian#0xdee9_custodian_unlock_balance">custodian::unlock_balance</Link>(&<b>mut</b> pool.base_custodian, owner, order.quantity);
        };
        <b>let</b> canceled_order_event = <Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceledComponent">AllOrdersCanceledComponent</Link>&lt;BaseAsset, QuoteAsset&gt; \{
            client_order_id: order.client_order_id,
            order_id: order.order_id,
            is_bid: order.is_bid,
            owner: order.owner,
            original_quantity: order.original_quantity,
            base_asset_quantity_canceled: order.quantity,
            price: order.price
        };
        <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> canceled_order_events, canceled_order_event);

        i_order = i_order + 1;
    };

    <b>if</b> (!<Link to="../move-stdlib/vector#0x1_vector_is_empty">vector::is_empty</Link>(&canceled_order_events)) \{
        <Link to="../iota-framework/event#0x2_event_emit">event::emit</Link>(<Link to="clob_v2#0xdee9_clob_v2_AllOrdersCanceled">AllOrdersCanceled</Link>&lt;BaseAsset, QuoteAsset&gt; \{
            pool_id,
            orders_canceled: canceled_order_events,
        });
    };
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_list_open_orders"></Link>

## Function `list_open_orders`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_list_open_orders">list_open_orders</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>): <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_list_open_orders">list_open_orders</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    account_cap: &AccountCap
): <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>&gt; \{
    <b>let</b> owner = account_owner(account_cap);
    <b>let</b> <b>mut</b> open_orders = <Link to="../move-stdlib/vector#0x1_vector_empty">vector::empty</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>&gt;();
    <b>if</b> (!<Link to="clob_v2#0xdee9_clob_v2_usr_open_orders_exist">usr_open_orders_exist</Link>(pool, owner)) \{
        <b>return</b> open_orders
    };
    <b>let</b> usr_open_order_ids = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&pool.usr_open_orders, owner);
    <b>let</b> <b>mut</b> order_id = <Link to="../iota-framework/linked_table#0x2_linked_table_front">linked_table::front</Link>(usr_open_order_ids);
    <b>while</b> (!<Link to="../move-stdlib/option#0x1_option_is_none">option::is_none</Link>(order_id)) \{
        <b>let</b> order_price = *<Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(usr_open_order_ids, *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(order_id));
        <b>let</b> tick_level =
            <b>if</b> (<Link to="clob_v2#0xdee9_clob_v2_order_is_bid">order_is_bid</Link>(*<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(order_id))) borrow_leaf_by_key(&pool.bids, order_price)
            <b>else</b> borrow_leaf_by_key(&pool.asks, order_price);
        <b>let</b> order = <Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(&tick_level.open_orders, *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(order_id));
        <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> open_orders, <Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link> \{
            order_id: order.order_id,
            client_order_id: order.client_order_id,
            price: order.price,
            original_quantity: order.original_quantity,
            quantity: order.quantity,
            is_bid: order.is_bid,
            owner: order.owner,
            expire_timestamp: order.expire_timestamp,
            self_matching_prevention: order.self_matching_prevention
        });
        order_id = <Link to="../iota-framework/linked_table#0x2_linked_table_next">linked_table::next</Link>(usr_open_order_ids, *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(order_id));
    };
    open_orders
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_account_balance"></Link>

## Function `account_balance`

query user balance inside custodian


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_account_balance">account_balance</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>): (u64, u64, u64, u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_account_balance">account_balance</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    account_cap: &AccountCap
): (u64, u64, u64, u64) \{
    <b>let</b> owner = account_owner(account_cap);
    <b>let</b> (base_avail, base_locked) = <Link to="custodian#0xdee9_custodian_account_balance">custodian::account_balance</Link>(&pool.base_custodian, owner);
    <b>let</b> (quote_avail, quote_locked) = <Link to="custodian#0xdee9_custodian_account_balance">custodian::account_balance</Link>(&pool.quote_custodian, owner);
    (base_avail, base_locked, quote_avail, quote_locked)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_get_market_price"></Link>

## Function `get_market_price`

Query the market price of order book
returns (best_bid_price, best_ask_price) if there exists
bid/ask order in the order book, otherwise returns None


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_get_market_price">get_market_price</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): (<Link to="../move-stdlib/option#0x1_option_Option">option::Option</Link>&lt;u64&gt;, <Link to="../move-stdlib/option#0x1_option_Option">option::Option</Link>&lt;u64&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_get_market_price">get_market_price</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;
): (Option&lt;u64&gt;, Option&lt;u64&gt;)\{
    <b>let</b> bid_price = <b>if</b> (!<Link to="critbit#0xdee9_critbit_is_empty">critbit::is_empty</Link>(&pool.bids)) \{
        <b>let</b> (result, _) = <Link to="critbit#0xdee9_critbit_max_leaf">critbit::max_leaf</Link>(&pool.bids);
        <Link to="../move-stdlib/option#0x1_option_some">option::some</Link>&lt;u64&gt;(result)
    } <b>else</b> \{
        <Link to="../move-stdlib/option#0x1_option_none">option::none</Link>&lt;u64&gt;()
    };
    <b>let</b> ask_price = <b>if</b> (!<Link to="critbit#0xdee9_critbit_is_empty">critbit::is_empty</Link>(&pool.asks)) \{
        <b>let</b> (result, _) = <Link to="critbit#0xdee9_critbit_min_leaf">critbit::min_leaf</Link>(&pool.asks);
        <Link to="../move-stdlib/option#0x1_option_some">option::some</Link>&lt;u64&gt;(result)
    } <b>else</b> \{
        <Link to="../move-stdlib/option#0x1_option_none">option::none</Link>&lt;u64&gt;()
    };
    <b>return</b> (bid_price, ask_price)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_get_level2_book_status_bid_side"></Link>

## Function `get_level2_book_status_bid_side`

Enter a price range and return the level2 order depth of all valid prices within this price range in bid side
returns two vectors of u64
The previous is a list of all valid prices
The latter is the corresponding depth list


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_get_level2_book_status_bid_side">get_level2_book_status_bid_side</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, price_low: u64, price_high: u64, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>): (<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_get_level2_book_status_bid_side">get_level2_book_status_bid_side</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    <b>mut</b> price_low: u64,
    <b>mut</b> price_high: u64,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock
): (<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;) \{
    <b>let</b> <b>mut</b> price_vec = <Link to="../move-stdlib/vector#0x1_vector_empty">vector::empty</Link>&lt;u64&gt;();
    <b>let</b> <b>mut</b> depth_vec = <Link to="../move-stdlib/vector#0x1_vector_empty">vector::empty</Link>&lt;u64&gt;();
    <b>if</b> (<Link to="critbit#0xdee9_critbit_is_empty">critbit::is_empty</Link>(&pool.bids)) \{ <b>return</b> (price_vec, depth_vec) };
    <b>let</b> (price_low_, _) = <Link to="critbit#0xdee9_critbit_min_leaf">critbit::min_leaf</Link>(&pool.bids);
    <b>let</b> (price_high_, _) = <Link to="critbit#0xdee9_critbit_max_leaf">critbit::max_leaf</Link>(&pool.bids);

    // If price_low is greater than the highest element in the tree, we <b>return</b> empty
    <b>if</b> (price_low &gt; price_high_) \{
        <b>return</b> (price_vec, depth_vec)
    };

    <b>if</b> (price_low &lt; price_low_) price_low = price_low_;
    <b>if</b> (price_high &gt; price_high_) price_high = price_high_;
    <b>let</b> closest_low = <Link to="critbit#0xdee9_critbit_find_closest_key">critbit::find_closest_key</Link>(&pool.bids, price_low);
    <b>let</b> closest_high = <Link to="critbit#0xdee9_critbit_find_closest_key">critbit::find_closest_key</Link>(&pool.bids, price_high);
    <b>if</b> (price_low &lt;= closest_low)\{
        price_low = closest_low;
    } <b>else</b> \{
        (price_low, _) = <Link to="critbit#0xdee9_critbit_next_leaf">critbit::next_leaf</Link>(&pool.bids, closest_low);
    };
    <b>if</b> (price_high &gt;= closest_high)\{
        price_high = closest_high;
    } <b>else</b> \{
        (price_high, _) = <Link to="critbit#0xdee9_critbit_previous_leaf">critbit::previous_leaf</Link>(&pool.bids, closest_high);
    };

    <b>while</b> (price_low &lt;= price_high) \{
        <b>let</b> depth = <Link to="clob_v2#0xdee9_clob_v2_get_level2_book_status">get_level2_book_status</Link>(
            &pool.bids,
            price_low,
            <Link to="../iota-framework/clock#0x2_clock_timestamp_ms">clock::timestamp_ms</Link>(<Link to="../iota-framework/clock#0x2_clock">clock</Link>)
        );
        <b>if</b> (depth != 0) \{
            <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> price_vec, price_low);
            <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> depth_vec, depth);
        };
        <b>let</b> (next_price, _) = <Link to="critbit#0xdee9_critbit_next_leaf">critbit::next_leaf</Link>(&pool.bids, price_low);
        <b>if</b> (next_price == 0) \{ <b>break</b> }
        <b>else</b> \{ price_low = next_price };
    };
    (price_vec, depth_vec)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_get_level2_book_status_ask_side"></Link>

## Function `get_level2_book_status_ask_side`

Enter a price range and return the level2 order depth of all valid prices within this price range in ask side
returns two vectors of u64
The previous is a list of all valid prices
The latter is the corresponding depth list


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_get_level2_book_status_ask_side">get_level2_book_status_ask_side</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, price_low: u64, price_high: u64, <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &<Link to="../iota-framework/clock#0x2_clock_Clock">clock::Clock</Link>): (<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_get_level2_book_status_ask_side">get_level2_book_status_ask_side</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    <b>mut</b> price_low: u64,
    <b>mut</b> price_high: u64,
    <Link to="../iota-framework/clock#0x2_clock">clock</Link>: &Clock
): (<Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;, <Link to="../move-stdlib/vector#0x1_vector">vector</Link>&lt;u64&gt;) \{
    <b>let</b> <b>mut</b> price_vec = <Link to="../move-stdlib/vector#0x1_vector_empty">vector::empty</Link>&lt;u64&gt;();
    <b>let</b> <b>mut</b> depth_vec = <Link to="../move-stdlib/vector#0x1_vector_empty">vector::empty</Link>&lt;u64&gt;();
    <b>if</b> (<Link to="critbit#0xdee9_critbit_is_empty">critbit::is_empty</Link>(&pool.asks)) \{ <b>return</b> (price_vec, depth_vec) };
    <b>let</b> (price_low_, _) = <Link to="critbit#0xdee9_critbit_min_leaf">critbit::min_leaf</Link>(&pool.asks);
    <b>let</b> (price_high_, _) = <Link to="critbit#0xdee9_critbit_max_leaf">critbit::max_leaf</Link>(&pool.asks);

    // Price_high is less than the lowest leaf in the tree then we <b>return</b> an empty array
    <b>if</b> (price_high &lt; price_low_) \{
        <b>return</b> (price_vec, depth_vec)
    };

    <b>if</b> (price_low &lt; price_low_) price_low = price_low_;
    <b>if</b> (price_high &gt; price_high_) price_high = price_high_;
    <b>let</b> closest_low = <Link to="critbit#0xdee9_critbit_find_closest_key">critbit::find_closest_key</Link>(&pool.asks, price_low);
    <b>let</b> closest_high = <Link to="critbit#0xdee9_critbit_find_closest_key">critbit::find_closest_key</Link>(&pool.asks, price_high);
    <b>if</b> (price_low &lt;= closest_low)\{
        price_low = closest_low;
    } <b>else</b> \{
        (price_low, _) = <Link to="critbit#0xdee9_critbit_next_leaf">critbit::next_leaf</Link>(&pool.bids, closest_low);
    };
    <b>if</b> (price_high &gt;= closest_high)\{
        price_high = closest_high;
    } <b>else</b> \{
        (price_high, _) = <Link to="critbit#0xdee9_critbit_previous_leaf">critbit::previous_leaf</Link>(&pool.bids, closest_high);
    };

    <b>while</b> (price_low &lt;= price_high) \{
        <b>let</b> depth = <Link to="clob_v2#0xdee9_clob_v2_get_level2_book_status">get_level2_book_status</Link>(
            &pool.asks,
            price_low,
            <Link to="../iota-framework/clock#0x2_clock_timestamp_ms">clock::timestamp_ms</Link>(<Link to="../iota-framework/clock#0x2_clock">clock</Link>)
        );
        <b>if</b> (depth != 0) \{
            <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> price_vec, price_low);
            <Link to="../move-stdlib/vector#0x1_vector_push_back">vector::push_back</Link>(&<b>mut</b> depth_vec, depth);
        };
        <b>let</b> (next_price, _) = <Link to="critbit#0xdee9_critbit_next_leaf">critbit::next_leaf</Link>(&pool.asks, price_low);
        <b>if</b> (next_price == 0) \{ <b>break</b> }
        <b>else</b> \{ price_low = next_price };
    };
    (price_vec, depth_vec)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_get_level2_book_status"></Link>

## Function `get_level2_book_status`

internal func to retrieve single depth of a tick price


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_get_level2_book_status">get_level2_book_status</Link>(open_orders: &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">clob_v2::TickLevel</Link>&gt;, price: u64, time_stamp: u64): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_get_level2_book_status">get_level2_book_status</Link>(
    open_orders: &CritbitTree&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link>&gt;,
    price: u64,
    time_stamp: u64
): u64 \{
    <b>let</b> tick_level = <Link to="critbit#0xdee9_critbit_borrow_leaf_by_key">critbit::borrow_leaf_by_key</Link>(open_orders, price);
    <b>let</b> tick_open_orders = &tick_level.open_orders;
    <b>let</b> <b>mut</b> depth = 0;
    <b>let</b> <b>mut</b> order_id = <Link to="../iota-framework/linked_table#0x2_linked_table_front">linked_table::front</Link>(tick_open_orders);
    <b>let</b> <b>mut</b> order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>;
    <b>while</b> (!<Link to="../move-stdlib/option#0x1_option_is_none">option::is_none</Link>(order_id)) \{
        order = <Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(tick_open_orders, *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(order_id));
        <b>if</b> (order.expire_timestamp &gt; time_stamp) depth = depth + order.quantity;
        order_id = <Link to="../iota-framework/linked_table#0x2_linked_table_next">linked_table::next</Link>(tick_open_orders, *<Link to="../move-stdlib/option#0x1_option_borrow">option::borrow</Link>(order_id));
    };
    depth
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_get_order_status"></Link>

## Function `get_order_status`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_get_order_status">get_order_status</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;, order_id: u64, account_cap: &<Link to="custodian_v2#0xdee9_custodian_v2_AccountCap">custodian_v2::AccountCap</Link>): &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_get_order_status">get_order_status</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;,
    order_id: u64,
    account_cap: &AccountCap
): &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link> \{
    <b>let</b> owner = account_owner(account_cap);
    <b>assert</b>!(<Link to="../iota-framework/table#0x2_table_contains">table::contains</Link>(&pool.usr_open_orders, owner), <Link to="clob_v2#0xdee9_clob_v2_EInvalidUser">EInvalidUser</Link>);
    <b>let</b> usr_open_order_ids = <Link to="../iota-framework/table#0x2_table_borrow">table::borrow</Link>(&pool.usr_open_orders, owner);
    <b>assert</b>!(<Link to="../iota-framework/linked_table#0x2_linked_table_contains">linked_table::contains</Link>(usr_open_order_ids, order_id), <Link to="clob_v2#0xdee9_clob_v2_EInvalidOrderId">EInvalidOrderId</Link>);
    <b>let</b> order_price = *<Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(usr_open_order_ids, order_id);
    <b>let</b> open_orders =
        <b>if</b> (<Link to="clob_v2#0xdee9_clob_v2_order_id">order_id</Link> &lt; <Link to="clob_v2#0xdee9_clob_v2_MIN_ASK_ORDER_ID">MIN_ASK_ORDER_ID</Link>) \{ &pool.bids }
        <b>else</b> \{ &pool.asks };
    <b>let</b> tick_level = <Link to="critbit#0xdee9_critbit_borrow_leaf_by_key">critbit::borrow_leaf_by_key</Link>(open_orders, order_price);
    <b>let</b> tick_open_orders = &tick_level.open_orders;
    <b>let</b> order = <Link to="../iota-framework/linked_table#0x2_linked_table_borrow">linked_table::borrow</Link>(tick_open_orders, order_id);
    order
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_matched_order_metadata"></Link>

## Function `matched_order_metadata`



<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_matched_order_metadata">matched_order_metadata</Link>&lt;BaseAsset, QuoteAsset&gt;(pool_id: <Link to="../iota-framework/object#0x2_object_ID">object::ID</Link>, taker_address: <b>address</b>, order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>, base_asset_quantity_filled: u64, taker_commission: u64, maker_rebates: u64): <Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_matched_order_metadata">matched_order_metadata</Link>&lt;BaseAsset, QuoteAsset&gt;(
    pool_id: ID,
    taker_address: <b>address</b>,
    order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>,
    base_asset_quantity_filled: u64,
    taker_commission: u64,
    maker_rebates: u64
): <Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;\{
    <Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt; \{
        pool_id,
        order_id: order.order_id,
        is_bid: order.is_bid,
        taker_address,
        maker_address: order.owner,
        base_asset_quantity_filled,
        price: order.price,
        taker_commission,
        maker_rebates
    }
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_matched_order_metadata_info"></Link>

## Function `matched_order_metadata_info`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_matched_order_metadata_info">matched_order_metadata_info</Link>&lt;BaseAsset, QuoteAsset&gt;(matched_order_metadata: &<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">clob_v2::MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;): (<Link to="../iota-framework/object#0x2_object_ID">object::ID</Link>, u64, bool, <b>address</b>, <b>address</b>, u64, u64, u64, u64)
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_matched_order_metadata_info">matched_order_metadata_info</Link>&lt;BaseAsset, QuoteAsset&gt;(
    matched_order_metadata: &<Link to="clob_v2#0xdee9_clob_v2_MatchedOrderMetadata">MatchedOrderMetadata</Link>&lt;BaseAsset, QuoteAsset&gt;
) : ( ID, u64, bool, <b>address</b>, <b>address</b>, u64, u64, u64, u64) \{
    (
        matched_order_metadata.pool_id,
        matched_order_metadata.order_id,
        matched_order_metadata.is_bid,
        matched_order_metadata.taker_address,
        matched_order_metadata.maker_address,
        matched_order_metadata.base_asset_quantity_filled,
        matched_order_metadata.price,
        matched_order_metadata.taker_commission,
        matched_order_metadata.maker_rebates
    )
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_asks"></Link>

## Function `asks`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_asks">asks</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">clob_v2::TickLevel</Link>&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_asks">asks</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): &CritbitTree&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link>&gt; \{
    &pool.asks
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_bids"></Link>

## Function `bids`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_bids">bids</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): &<Link to="critbit#0xdee9_critbit_CritbitTree">critbit::CritbitTree</Link>&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">clob_v2::TickLevel</Link>&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_bids">bids</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): &CritbitTree&lt;<Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link>&gt; \{
    &pool.bids
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_tick_size"></Link>

## Function `tick_size`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_tick_size">tick_size</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_tick_size">tick_size</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): u64 \{
    pool.tick_size
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_maker_rebate_rate"></Link>

## Function `maker_rebate_rate`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_maker_rebate_rate">maker_rebate_rate</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_maker_rebate_rate">maker_rebate_rate</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): u64 \{
    pool.maker_rebate_rate
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_taker_fee_rate"></Link>

## Function `taker_fee_rate`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_taker_fee_rate">taker_fee_rate</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_taker_fee_rate">taker_fee_rate</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): u64 \{
    pool.taker_fee_rate
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_pool_size"></Link>

## Function `pool_size`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_pool_size">pool_size</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_pool_size">pool_size</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): u64 \{
    <Link to="critbit#0xdee9_critbit_size">critbit::size</Link>(&pool.asks) + <Link to="critbit#0xdee9_critbit_size">critbit::size</Link>(&pool.bids)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_open_orders"></Link>

## Function `open_orders`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_open_orders">open_orders</Link>(tick_level: &<Link to="clob_v2#0xdee9_clob_v2_TickLevel">clob_v2::TickLevel</Link>): &<Link to="../iota-framework/linked_table#0x2_linked_table_LinkedTable">linked_table::LinkedTable</Link>&lt;u64, <Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>&gt;
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_open_orders">open_orders</Link>(tick_level: &<Link to="clob_v2#0xdee9_clob_v2_TickLevel">TickLevel</Link>): &LinkedTable&lt;u64, <Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>&gt; \{
    &tick_level.open_orders
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_order_id"></Link>

## Function `order_id`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_order_id">order_id</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_order_id">order_id</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>): u64 \{
    order.order_id
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_tick_level"></Link>

## Function `tick_level`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_tick_level">tick_level</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_tick_level">tick_level</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>): u64 \{
    order.price
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_original_quantity"></Link>

## Function `original_quantity`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_original_quantity">original_quantity</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_original_quantity">original_quantity</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>): u64 \{
    order.original_quantity
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_quantity"></Link>

## Function `quantity`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_quantity">quantity</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_quantity">quantity</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>): u64 \{
    order.quantity
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_is_bid"></Link>

## Function `is_bid`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_is_bid">is_bid</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>): bool
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_is_bid">is_bid</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>): bool \{
    order.is_bid
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_owner"></Link>

## Function `owner`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_owner">owner</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>): <b>address</b>
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_owner">owner</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>): <b>address</b> \{
    order.owner
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_expire_timestamp"></Link>

## Function `expire_timestamp`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_expire_timestamp">expire_timestamp</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_expire_timestamp">expire_timestamp</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>): u64 \{
    order.expire_timestamp
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_quote_asset_trading_fees_value"></Link>

## Function `quote_asset_trading_fees_value`



<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_quote_asset_trading_fees_value">quote_asset_trading_fees_value</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">clob_v2::Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): u64
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b> <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_quote_asset_trading_fees_value">quote_asset_trading_fees_value</Link>&lt;BaseAsset, QuoteAsset&gt;(pool: &<Link to="clob_v2#0xdee9_clob_v2_Pool">Pool</Link>&lt;BaseAsset, QuoteAsset&gt;): u64 \{
    <Link to="../iota-framework/balance#0x2_balance_value">balance::value</Link>(&pool.quote_asset_trading_fees)
}
</code></pre>



</details>

<Link id="0xdee9_clob_v2_clone_order"></Link>

## Function `clone_order`



<pre><code>
<b>public</b>(<b>friend</b>) <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_clone_order">clone_order</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>): <Link to="clob_v2#0xdee9_clob_v2_Order">clob_v2::Order</Link>
</code></pre>



<details>
<summary>Implementation</summary>


<pre><code>
<b>public</b>(package) <b>fun</b> <Link to="clob_v2#0xdee9_clob_v2_clone_order">clone_order</Link>(order: &<Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link>): <Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link> \{
    <Link to="clob_v2#0xdee9_clob_v2_Order">Order</Link> \{
        order_id: order.order_id,
        client_order_id: order.client_order_id,
        price: order.price,
        original_quantity: order.original_quantity,
        quantity: order.quantity,
        is_bid: order.is_bid,
        owner: order.owner,
        expire_timestamp: order.expire_timestamp,
        self_matching_prevention: order.self_matching_prevention
    }
}
</code></pre>



</details>
