name: Update Dependencies

on:
  ## Allow triggering this workflow manually via GitHub CLI/web
  workflow_dispatch:
  # Running this workflow automatically was relevant when Narwhal development was split
  # at https://github.com/mystenlabs/narwhal, but it is now shared in this repo.
  # This should be re-activated when NW development happens there again.
  # schedule:
# Update on every hour at 10 past the hour
# - cron:  '10 * * * *'

jobs:
  update-dep:
    runs-on: self-hosted
    # Important settings as we don't want to open a PR when the update fails
    continue-on-error: false
    steps:
      - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # pin@v4
      # Fork of 'Swatinem/rust-cache' which allows caching additional paths
      - uses: bmwill/rust-cache@fb63fcd7a959767755b88b5af2f5cbf65fb8a127 # pin@v1
      - name: Install cargo-hakari, and cache the binary
        uses: baptiste0928/cargo-install@1cd874a5478fdca35d868ccc74640c5aabbb8f1b # pin@v3.0.0
        with:
          crate: cargo-hakari
          locked: true
      - name: Update the Narwhal pointer
        run: |
          scripts/update_narwhal.sh
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@4e1beaa7521e8b457b572c090b25bd3db56bf1c5 # pin@v5
        with:
          token: ${{ secrets.NW_AUTO_UPDATE }}
          commit-message: chore(deps) Update the Narwhal pointer
          title: chore(deps) Update the Narwhal pointer
          body: |
            - Update Narwhal

            Auto-generated by [create-pull-request][1] an the scripts/update_narwhal.sh script

            [1]: https://github.com/peter-evans/create-pull-request
          branch: update-narwhal
